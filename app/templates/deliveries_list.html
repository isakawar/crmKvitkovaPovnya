{% extends 'layout.html' %}
{% block content %}
<h2 class="mb-4">–î–æ—Å—Ç–∞–≤–∫–∏</h2>
<div class="mb-2">
  <strong>–í—Å—å–æ–≥–æ –¥–æ—Å—Ç–∞–≤–æ–∫: {{ deliveries_count }}</strong>
  <small class="text-muted ms-3">üí° –ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ –ø–æ —Ä—è–¥–∫—É –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</small>
</div>
<div class="d-flex align-items-center mb-3">
  <form class="d-flex align-items-center w-100" method="get" id="delivery-filter-form">
    <input type="text" name="client_phone" class="form-control form-control-sm me-2" style="width:180px;" placeholder="–ü–æ—à—É–∫ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –∫–ª—ñ—î–Ω—Ç–∞..." value="{{ request.args.get('client_phone', '') }}">
    <input type="date" id="filter-date" name="date" class="form-control form-control-sm me-2" style="width:170px;" value="{{ selected_date }}">
    <select id="filter-status" name="status" class="form-select form-select-sm me-2" style="width:170px;">
      <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
      <option value="–û—á—ñ–∫—É—î">–û—á—ñ–∫—É—î</option>
      <option value="–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ">–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ</option>
      <option value="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</option>
      <option value="–ù–ü">–ù–ü</option>
    </select>
    <button class="btn btn-outline-primary btn-sm me-2" type="submit">–û–∫</button>
    <button class="btn btn-outline-secondary btn-sm" id="reset-date-btn" type="button">–°–∫–∏–Ω—É—Ç–∏</button>
  </form>
</div>
<table class="table table-bordered table-hover align-middle">
  <thead>
    <tr>
      <th>ID</th>
      <th>–ö–ª—ñ—î–Ω—Ç</th>
      <th>–ê–¥—Ä–µ—Å–∞</th>
      <th>–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</th>
      <th>–†–æ–∑–º—ñ—Ä</th>
      <th>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</th>
      <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
      <th style="width:90px;">–ß–∞—Å</th>
      <th>–î–∞—Ç–∞</th>
      <th>–°—Ç–∞—Ç—É—Å</th>
    </tr>
  </thead>
  <tbody>
    {% for d in deliveries %}
    <tr data-status="{{ d.status }}" style="cursor: pointer;" 
        {% if not d.is_subscription and d.delivery_type in ['Weekly', 'Monthly', 'Bi-weekly'] %}
        class="unpaid-subscription-delivery"
        {% endif %}>
      <td>{{ d.id }}</td>
      <td>{% if d.client and d.client.instagram %}{{ d.client.instagram }}{% else %}‚Äî{% endif %}</td>
      <td>
        {% if d.is_pickup %}
          <span class="tag tag-easy">–°–∞–º–æ–≤–∏–≤—ñ–∑</span>
        {% else %}
          <a href="#" class="address-link" 
             data-street="{{ d.street }}" 
             data-building="{{ d.building_number }}" 
             data-entrance="{{ d.entrance }}"
             style="color:inherit; text-decoration:none; cursor:pointer;">
            {{ d.street }}{% if d.building_number %}, {{ d.building_number }}{% endif %}
          </a>
        {% endif %}
      </td>
      <td>{{ d.phone }}</td>
      <td>{% if d.bouquet_size %}{{ d.bouquet_size }}{% elif d.size %}{{ d.size }}{% else %}-{% endif %}</td>
      <td>
        {{ d.delivery_type }}
        {% if not d.is_subscription and d.delivery_type in ['Weekly', 'Monthly', 'Bi-weekly'] %}
          <span class="badge bg-warning text-dark ms-1" title="–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ - –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É">!</span>
        {% endif %}
      </td>
      <td>{{ d.comment }}</td>
      <td>
        {% if d.time_from and d.time_to %}
          {{ d.time_from }}-{{ d.time_to }}
        {% elif d.time_from and not d.time_to %}
          –∑ {{ d.time_from }}
        {% elif d.time_to and not d.time_from %}
          –¥–æ {{ d.time_to }}
        {% else %}
          &nbsp;
        {% endif %}
      </td>
      <td>{{ d.delivery_date.strftime('%d.%m') }}</td>
      <td>
        <span class="delivery-status badge 
          {% if d.status == '–û—á—ñ–∫—É—î' %}bg-secondary
          {% elif d.status == '–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ' %}bg-primary
          {% elif d.status == '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ' %}bg-success
          {% elif d.status == '–ù–ü' %}bg-danger
          {% else %}bg-light text-dark
          {% endif %}"
          data-id="{{ d.id }}" data-status="{{ d.status }}" style="cursor:pointer;">
          {{ d.status }}
        </span>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
{% if deliveries_count > 30 %}
<div class="d-flex justify-content-center align-items-center gap-2">
    <form method="get" style="display:inline;">
        {% for key, value in request.args.items() %}
            {% if key != 'page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button class="btn btn-secondary" name="page" value="{{ prev_page }}" {% if page == 1 %}disabled{% endif %}>–ù–∞–∑–∞–¥</button>
    </form>
    <span class="mx-2">{{ page }}</span>
    <form method="get" style="display:inline;">
        {% for key, value in request.args.items() %}
            {% if key != 'page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button class="btn btn-secondary" name="page" value="{{ next_page }}" {% if not has_next %}disabled{% endif %}>–í–ø–µ—Ä–µ–¥</button>
    </form>
</div>
{% endif %}

<!-- Modal -->
<div class="modal fade" id="editDeliveryModal" tabindex="-1" aria-labelledby="editDeliveryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDeliveryModalLabel">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editDeliveryForm">
          <input type="hidden" name="delivery_id" id="editDeliveryId">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">–ú—ñ—Å—Ç–æ</label>
              <input type="text" class="form-control" id="editCity" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">–í—É–ª–∏—Ü—è</label>
              <input type="text" class="form-control" id="editStreet">
            </div>
            <div class="col-md-3">
              <label class="form-label">‚Ññ –±—É–¥–∏–Ω–∫—É</label>
              <input type="text" class="form-control" id="editBuildingNumber">
            </div>
            <div class="col-md-3">
              <label class="form-label">–ß–∞—Å –∑</label>
              <input type="time" class="form-control" id="editTimeFrom">
            </div>
            <div class="col-md-3">
              <label class="form-label">–ß–∞—Å –¥–æ</label>
              <input type="time" class="form-control" id="editTimeTo">
            </div>
            <div class="col-md-6">
              <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</label>
              <input type="text" class="form-control" id="editPhone">
            </div>
            <div class="col-md-4">
              <label class="form-label">–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
              <input type="date" class="form-control" id="editDeliveryDate">
            </div>
            <div class="col-md-12">
              <label class="form-label">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
              <textarea class="form-control" id="editComment"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button type="button" class="btn btn-primary" id="saveDeliveryBtn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmStatusModal" tabindex="-1" aria-labelledby="confirmStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmStatusModalLabel">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        –ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ <b>–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</b>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ù—ñ</button>
        <button type="button" class="btn btn-success" id="confirmDeliveredBtn">–¢–∞–∫</button>
      </div>
    </div>
  </div>
</div>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addressModalLabel">–ü–æ–≤–Ω–∞ –∞–¥—Ä–µ—Å–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="addressModalBody">
      </div>
    </div>
  </div>
</div>

<!-- Modal –¥–ª—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫—É—Ä'—î—Ä–∞ (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ assign_deliveries.html) -->
<div class="modal fade" id="assignCourierModal" tabindex="-1" aria-labelledby="assignCourierModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="assignCourierForm">
        <div class="modal-header">
          <h5 class="modal-title" id="assignCourierModalLabel">–í–∏–±–µ—Ä—ñ—Ç—å –∫—É—Ä'—î—Ä–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <select id="courierSelect" class="form-select mb-3" required>
            <option value="">–û–±–µ—Ä—ñ—Ç—å –∫—É—Ä'—î—Ä–∞</option>
            {% for courier in couriers %}
              <option value="{{ courier.id }}">{{ courier.name }}</option>
            {% endfor %}
          </select>
          <div id="selected-addresses" class="mb-2"></div>
          <div id="assign-error" class="alert alert-danger d-none mt-2"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø–æ —Å—Ç–∞—Ç—É—Å—É —Ç–∞ –¥–∞—Ç—ñ (frontend) ---
  const filterDate = document.getElementById('filter-date');
  const filterStatus = document.getElementById('filter-status');
  const applyBtn = document.getElementById('apply-date-btn');
  const resetBtn = document.getElementById('reset-date-btn');
  const tableRows = document.querySelectorAll('tbody tr');

  function filterTable() {
    const dateVal = filterDate ? filterDate.value : '';
    const statusVal = filterStatus ? filterStatus.value : '';
    tableRows.forEach(row => {
      let show = true;
      if (dateVal) {
        const dateCell = row.querySelector('td:nth-child(9)');
        // –ü–æ—Ä—ñ–≤–Ω—é—î–º–æ –¥–∞—Ç–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–¥.–º–º
        const rowDate = dateCell ? dateCell.textContent.trim() : '';
        const jsDate = new Date(dateVal);
        const formatted = jsDate.toLocaleDateString('uk-UA', {day:'2-digit', month:'2-digit'});
        if (rowDate !== formatted) show = false;
      }
      if (statusVal) {
        if (row.getAttribute('data-status') !== statusVal) show = false;
      }
      row.style.display = show ? '' : 'none';
    });
  }

  if (filterStatus) filterStatus.addEventListener('change', filterTable);
  if (filterDate) filterDate.addEventListener('change', filterTable);
  if (resetBtn) {
    resetBtn.addEventListener('click', function() {
      if (filterDate) filterDate.value = '';
      if (filterStatus) filterStatus.value = '';
      filterTable();
    });
  }
  if (applyBtn) applyBtn.addEventListener('click', filterTable);

  // --- –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –∑–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É ---
  let currentDeliveryId = null;
  const assignModalElement = document.getElementById('assignCourierModal');
  const confirmModalElement = document.getElementById('confirmStatusModal');
  const assignModal = assignModalElement ? new bootstrap.Modal(assignModalElement) : null;
  const confirmModal = confirmModalElement ? new bootstrap.Modal(confirmModalElement) : null;

  document.querySelectorAll('.delivery-status').forEach(span => {
    span.addEventListener('click', function() {
      const status = this.dataset.status;
      currentDeliveryId = this.dataset.id;
      if (status === '–û—á—ñ–∫—É—î' && assignModal) {
        const courierSelect = document.getElementById('courierSelect');
        const assignError = document.getElementById('assign-error');
        if (courierSelect) courierSelect.value = '';
        if (assignError) assignError.classList.add('d-none');
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∞–¥—Ä–µ—Å—É –¥–ª—è —Ü—ñ—î—ó –¥–æ—Å—Ç–∞–≤–∫–∏
        const row = span.closest('tr');
        const city = row.querySelector('td:nth-child(2)').textContent.trim();
        const address = row.querySelector('td:nth-child(3)').textContent.trim();
        const date = row.querySelector('td:nth-child(9)').textContent.trim();
        const selectedAddresses = document.getElementById('selected-addresses');
        if (selectedAddresses) {
          selectedAddresses.innerHTML = `<b>–í–∏ –ø—Ä–∏–∑–Ω–∞—á–∞—î—Ç–µ –∫—É—Ä º—î—Ä–∞ –Ω–∞ –∞–¥—Ä–µ—Å—É:</b><ul><li>${city}, ${address} ‚Äî ${date}</li></ul>`;
        }
        assignModal.show();
      } else if (status === '–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ' && confirmModal) {
        confirmModal.show();
      }
    });
  });

  // –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫—É—Ä'—î—Ä–∞ (submit)
  const assignCourierForm = document.getElementById('assignCourierForm');
  if (assignCourierForm) {
    assignCourierForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const courierId = document.getElementById('courierSelect') ? document.getElementById('courierSelect').value : '';
      const errorDiv = document.getElementById('assign-error');
      if (errorDiv) errorDiv.classList.add('d-none');
      if (!courierId) {
        if (errorDiv) {
          errorDiv.textContent = '–û–±–µ—Ä—ñ—Ç—å –∫—É—Ä º—î—Ä–∞!';
          errorDiv.classList.remove('d-none');
        }
        return;
      }
      fetch(`/deliveries/assign-courier`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({delivery_ids: [currentDeliveryId], courier_id: courierId})
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          if (errorDiv) {
            errorDiv.textContent = data.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ!';
            errorDiv.classList.remove('d-none');
          }
        }
      });
    });
  }

  // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è "–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ?"
  const confirmDeliveredBtn = document.getElementById('confirmDeliveredBtn');
  if (confirmDeliveredBtn) {
    confirmDeliveredBtn.onclick = function() {
      fetch(`/deliveries/${currentDeliveryId}/status`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'})
      }).then(r => r.json()).then(data => {
        if (data.success) {
          location.reload();
        }
      });
    }
  }

  // --- –õ–æ–≥—ñ–∫–∞ –¥–ª—è –∞–¥—Ä–µ—Å–∏ (–ø–æ–ø–∞–ø) ---
  const addressModalElement = document.getElementById('addressModal');
  const addressModal = addressModalElement ? new bootstrap.Modal(addressModalElement) : null;
  document.querySelectorAll('.address-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const city = this.dataset.city || '';
      const street = this.dataset.street || '';
      const building = this.dataset.building || '';
      const entrance = this.dataset.entrance || '';
      let html = `<b>–ú—ñ—Å—Ç–æ:</b> ${city}<br><b>–í—É–ª–∏—Ü—è:</b> ${street}<br><b>–ë—É–¥–∏–Ω–æ–∫:</b> ${building}`;
      if (entrance) html += `<br><b>–ü—ñ–¥'—ó–∑–¥:</b> ${entrance}`;
      const addressModalBody = document.getElementById('addressModalBody');
      if (addressModalBody) {
        addressModalBody.innerHTML = html;
      }
      if (addressModal) {
        addressModal.show();
      }
    });
  });

  // --- –õ–æ–≥—ñ–∫–∞ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏ (double click –ø–æ —Ä—è–¥–∫—É) ---
  const editModalElement = document.getElementById('editDeliveryModal');
  const editModal = editModalElement ? new bootstrap.Modal(editModalElement) : null;
  let currentId = null;
  
  if (!editModal) {
    console.error('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
  }
  
  document.querySelectorAll('tbody tr').forEach(row => {
    row.addEventListener('dblclick', function() {
      console.log('–î–∞–±–ª –∫–ª—ñ–∫ —Å–ø—Ä–∞—Ü—é–≤–∞–≤');
      const id = this.children[0].innerText;
      console.log('ID –¥–æ—Å—Ç–∞–≤–∫–∏:', id);
      currentId = id;
      
      fetch(`/deliveries/${id}`)
        .then(r => {
          console.log('Fetch response status:', r.status);
          if (!r.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–∫–∏');
          }
          return r.json();
        })
        .then(data => {
          console.log('–û—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ:', data);
          document.getElementById('editDeliveryId').value = data.id;
          document.getElementById('editCity').value = data.city || '';
          document.getElementById('editStreet').value = data.street || '';
          document.getElementById('editBuildingNumber').value = data.building_number || '';
          document.getElementById('editPhone').value = data.phone || '';
          document.getElementById('editTimeFrom').value = data.time_from || '';
          document.getElementById('editTimeTo').value = data.time_to || '';
          document.getElementById('editDeliveryDate').value = data.delivery_date || '';
          document.getElementById('editComment').value = data.comment || '';
          console.log('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è');
          if (editModal) {
            editModal.show();
          } else {
            console.error('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
            alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞');
          }
        })
        .catch(error => {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–∫–∏');
        });
    });
  });
  
  // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏
  const saveDeliveryBtn = document.getElementById('saveDeliveryBtn');
  if (saveDeliveryBtn) {
    saveDeliveryBtn.addEventListener('click', function() {
      if (!currentId) {
        alert('–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è');
        return;
      }
      
      const payload = {
        street: document.getElementById('editStreet').value,
        building_number: document.getElementById('editBuildingNumber').value,
        phone: document.getElementById('editPhone').value,
        time_from: document.getElementById('editTimeFrom').value,
        time_to: document.getElementById('editTimeTo').value,
        delivery_date: document.getElementById('editDeliveryDate').value,
        comment: document.getElementById('editComment').value
      };
      
      fetch(`/deliveries/${currentId}/edit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r => {
        if (!r.ok) {
          throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
        }
        return r.json();
      })
      .then(data => {
        if (data.success) {
          editModal.hide();
          location.reload();
        } else {
          alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
        }
      })
      .catch(error => {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏');
      });
    });
  } else {
    console.error('–ö–Ω–æ–ø–∫–∞ saveDeliveryBtn –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
  }
});
</script>
{% endblock %} 