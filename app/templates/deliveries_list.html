{% extends 'layout.html' %}
{% block content %}
<h2 class="mb-4">–î–æ—Å—Ç–∞–≤–∫–∏</h2>
<div class="mb-2">
  <strong>–í—Å—å–æ–≥–æ –¥–æ—Å—Ç–∞–≤–æ–∫: {{ deliveries_count }}</strong>
  <small class="text-muted ms-3">üí° –ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ –ø–æ —Ä—è–¥–∫—É –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</small>
</div>
<div class="filter-bar mb-3 w-100" style="position: relative;">
  <form class="d-flex flex-wrap gap-2 align-items-center w-100" method="get" id="delivery-filter-form">
    {% if request.args.get('financial_week') %}
      <input type="hidden" name="financial_week" value="{{ request.args.get('financial_week') }}">
    {% endif %}
    <input type="text" name="client_instagram" class="form-control" style="max-width:160px; background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;" placeholder="–ü–æ—à—É–∫ –∑–∞ Instagram –∫–ª—ñ—î–Ω—Ç–∞..." value="{{ request.args.get('client_instagram', '') }}">
    <input type="text" name="recipient_phone" class="form-control" style="max-width:160px; background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;" placeholder="–ü–æ—à—É–∫ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –æ—Ç—Ä–∏–º—É–≤–∞—á–∞..." value="{{ request.args.get('recipient_phone', '') }}">
    <input type="date" id="filter-date" name="date" class="form-control" style="max-width:170px; background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;" value="{{ selected_date }}">
    <select id="filter-status" name="status" class="form-select" style="max-width:170px; background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
      <option value="" {% if request.args.get('status', '') == '' %}selected{% endif %}>–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
      <option value="–û—á—ñ–∫—É—î" {% if request.args.get('status') == '–û—á—ñ–∫—É—î' %}selected{% endif %}>–û—á—ñ–∫—É—î</option>
      <option value="–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ" {% if request.args.get('status') == '–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ' %}selected{% endif %}>–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ</option>
      <option value="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ" {% if request.args.get('status') == '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ' %}selected{% endif %}>–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</option>
      <option value="–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞" {% if request.args.get('status') == '–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞' %}selected{% endif %}>–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞</option>
    </select>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-sm {% if request.args.get('financial_week') == '0' %}btn-primary active-week{% else %}btn-outline-primary{% endif %}" id="current-week-btn">–ü–æ—Ç–æ—á–Ω–∏–π —Ñ—ñ–Ω. —Ç–∏–∂–¥–µ–Ω—å</button>
      <button type="button" class="btn btn-sm {% if request.args.get('financial_week') == '1' %}btn-primary active-week{% else %}btn-outline-primary{% endif %}" id="next-week-btn">–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ñ—ñ–Ω. —Ç–∏–∂–¥–µ–Ω—å</button>
    </div>
    <div class="me-5">
      <button class="btn btn-outline-secondary" id="reset-all-btn" type="button">–°–∫–∏–Ω—É—Ç–∏</button>
    </div>
  </form>
  <!-- –Ü–∫–æ–Ω–∫–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫ —É filter-bar -->
  <div style="position: absolute; top: 50%; right: 8px; transform: translateY(-50%); z-index: 10;">
    <button id="column-settings-btn" title="–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –∫–æ–ª–æ–Ω–∫–∏">
      <span style="font-size: 2.1rem;">&#9776;</span>
    </button>
    <div id="column-settings-menu">
      <strong>–ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –∫–æ–ª–æ–Ω–∫–∏</strong>
      <form id="column-settings-form">
        <label><input type="checkbox" class="column-toggle" data-col="id" checked>ID</label>
        <label><input type="checkbox" class="column-toggle" data-col="client" checked>–ö–ª—ñ—î–Ω—Ç</label>
        <label><input type="checkbox" class="column-toggle" data-col="address" checked>–ê–¥—Ä–µ—Å–∞</label>
        <label><input type="checkbox" class="column-toggle" data-col="phone" checked>–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</label>
        <label><input type="checkbox" class="column-toggle" data-col="size" checked>–†–æ–∑–º—ñ—Ä</label>
        <label><input type="checkbox" class="column-toggle" data-col="delivery_type" checked>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</label>
        <label><input type="checkbox" class="column-toggle" data-col="comment" checked>–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
        <label><input type="checkbox" class="column-toggle" data-col="preferences" checked>–ü–æ–±–∞–∂–∞–Ω–Ω—è</label>
        <label><input type="checkbox" class="column-toggle" data-col="time" checked>–ß–∞—Å</label>
        <label><input type="checkbox" class="column-toggle" data-col="date" checked>–î–∞—Ç–∞</label>
        <label><input type="checkbox" class="column-toggle" data-col="status" checked>–°—Ç–∞—Ç—É—Å</label>
        <button type="button" id="save-columns" style="margin-top:8px;" class="btn btn-sm btn-primary w-100">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </form>
    </div>
  </div>
</div>
<table class="table table-bordered table-hover align-middle">
  <thead>
    <tr>
      <th data-col="id">ID</th>
      <th data-col="client">–ö–ª—ñ—î–Ω—Ç</th>
      <th data-col="address">–ê–¥—Ä–µ—Å–∞</th>
      <th data-col="phone">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</th>
      <th data-col="size">–†–æ–∑–º—ñ—Ä</th>
      <th data-col="delivery_type">–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</th>
      <th data-col="comment">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
      <th data-col="preferences">–ü–æ–±–∞–∂–∞–Ω–Ω—è</th>
      <th data-col="time" style="width:90px;">–ß–∞—Å</th>
      <th data-col="date">–î–∞—Ç–∞</th>
      <th data-col="status">–°—Ç–∞—Ç—É—Å</th>
    </tr>
  </thead>
  <tbody>
    {% set weekday_map = {
      0: '–ü–æ–Ω–µ–¥—ñ–ª–æ–∫',
      1: '–í—ñ–≤—Ç–æ—Ä–æ–∫',
      2: '–°–µ—Ä–µ–¥–∞',
      3: '–ß–µ—Ç–≤–µ—Ä',
      4: '–ü º—è—Ç–Ω–∏—Ü—è',
      5: '–°—É–±–æ—Ç–∞',
      6: '–ù–µ–¥—ñ–ª—è'
    } %}
    {% if deliveries|length == 0 %}
      <tr><td colspan="10" class="text-center text-muted py-4">–î–æ—Å—Ç–∞–≤–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</td></tr>
    {% else %}
      {% for date, group in grouped_deliveries|dictsort %}
        <tr>
          <td colspan="10" style="background:linear-gradient(90deg,#eaf1fb 0%,#f7f8fa 100%); text-align:center; font-weight:700; color:#1565c0; font-size:1.18rem; border-radius:18px; margin:12px 0; border:none; padding:18px 0 10px 0; letter-spacing:0.5px; box-shadow:0 2px 12px 0 rgba(21,101,192,0.06);">
            <div style="display:inline-block; padding:2px 24px; border-radius:16px; background:#e3eafc;">
              {{ weekday_map[date.weekday()] }} <span style="color:#007bff; font-weight:600;">({{ date.strftime('%d.%m') }})</span> - {{ group|length }} –¥–æ—Å—Ç–∞–≤{{ '–∫–∞' if group|length == 1 else ('–∫–∏' if group|length in [2,3,4] else '–æ–∫') }}
            </div>
          </td>
        </tr>
        {% for d in group %}
          <tr data-status="{{ d.status }}"
              {% if d.status == '–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞' %}class="unpaid-row{% if not d.is_subscription and d.delivery_type in ['Weekly', 'Monthly', 'Bi-weekly'] %} unpaid-subscription-delivery{% endif %}"{% elif not d.is_subscription and d.delivery_type in ['Weekly', 'Monthly', 'Bi-weekly'] %}class="unpaid-subscription-delivery"{% endif %}
              style="cursor: pointer;">
            <td data-col="id">{{ d.id }}</td>
            <td data-col="client">{% if d.client and d.client.instagram %}{{ d.client.instagram }}{% else %}‚Äî{% endif %}</td>
            <td data-col="address">
              {% if d.is_pickup %}
                <span class="tag tag-easy">–°–∞–º–æ–≤–∏–≤—ñ–∑</span>
              {% else %}
                <a href="#" class="address-link" 
                   data-street="{{ d.street }}" 
                   data-building="{{ d.building_number }}" 
                   data-entrance="{{ d.entrance }}"
                   style="color:inherit; text-decoration:none; cursor:pointer;">
                  {{ d.street }}{% if d.building_number %}, {{ d.building_number }}{% endif %}
                </a>
              {% endif %}
            </td>
            <td data-col="phone">{{ d.phone }}</td>
            <td data-col="size">
              {% set size_val = d.bouquet_size if d.bouquet_size else d.size %}
              <span class="tag {% if size_val=='M' %}tag-easy{% elif size_val=='L' %}tag-medium{% elif size_val in ['XL','XXL'] %}tag-hard{% endif %}">{{ size_val or '-' }}</span>
            </td>
            <td data-col="delivery_type">
              <span class="tag">{{ d.delivery_type }}</span>
              {% if not d.is_subscription and d.delivery_type in ['Weekly', 'Monthly', 'Bi-weekly'] %}
                <span class="badge bg-warning text-dark ms-1" title="–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ - –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É">!</span>
              {% endif %}
            </td>
            <td data-col="comment">{{ d.comment }}</td>
            <td data-col="preferences">{{ d.preferences }}</td>
            <td data-col="time">
              {% if d.time_from and d.time_to %}
                {{ d.time_from }}-{{ d.time_to }}
              {% elif d.time_from and not d.time_to %}
                –∑ {{ d.time_from }}
              {% elif d.time_to and not d.time_from %}
                –¥–æ {{ d.time_to }}
              {% else %}
                &nbsp;
              {% endif %}
            </td>
            <td data-col="date" class="delivery-date-cell" data-delivery-id="{{ d.id }}" style="cursor: pointer;">{{ d.delivery_date.strftime('%d.%m') }}</td>
            <td data-col="status">
              <span class="delivery-status badge 
                {% if d.status == '–û—á—ñ–∫—É—î' %}bg-secondary
                {% elif d.status == '–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ' %}bg-primary
                {% elif d.status == '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ' %}bg-success
                {% elif d.status == '–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞' %}bg-danger text-white
                {% else %}bg-light text-dark
                {% endif %}"
                data-id="{{ d.id }}" data-status="{{ d.status }}" style="cursor:pointer;">
                {{ d.status }}
              </span>
            </td>
          </tr>
        {% endfor %}
      {% endfor %}
    {% endif %}
  </tbody>
</table>

<!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
{% if deliveries_count > 30 %}
<div class="d-flex justify-content-center align-items-center gap-2">
    <form method="get" style="display:inline;">
        {% for key, value in request.args.items() %}
            {% if key != 'page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button class="btn btn-secondary" name="page" value="{{ prev_page }}" {% if page == 1 %}disabled{% endif %}>–ù–∞–∑–∞–¥</button>
    </form>
    <span class="mx-2">{{ page }}</span>
    <form method="get" style="display:inline;">
        {% for key, value in request.args.items() %}
            {% if key != 'page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button class="btn btn-secondary" name="page" value="{{ next_page }}" {% if not has_next %}disabled{% endif %}>–í–ø–µ—Ä–µ–¥</button>
    </form>
</div>
{% endif %}

<!-- Modal -->
<div class="modal fade" id="editDeliveryModal" tabindex="-1" aria-labelledby="editDeliveryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content" style="border-radius:18px; box-shadow:0 4px 32px 0 rgba(0,123,255,0.07); border:none;">
      <form id="editDeliveryForm">
        <div class="modal-header d-flex align-items-center gap-2" style="border-bottom:none; background:#fff; border-radius:18px 18px 0 0;">
          <h5 class="modal-title d-flex align-items-center gap-2" id="editDeliveryModalLabel" style="font-weight:500; color:#23272f; font-size:1.18rem; margin-bottom:0;">
            –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏
            <button type="button" class="btn btn-outline-success btn-sm ms-2" id="extendDeliverySubscriptionBtn" style="display:none; border-radius:8px; padding:4px 8px;" data-bs-toggle="tooltip" data-bs-placement="top" title="–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É">
              <i class="bi bi-arrow-repeat"></i>
            </button>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="background:#fff; padding:32px 28px 18px 28px;">
          <input type="hidden" name="delivery_id" id="editDeliveryId">
          
          <div class="row g-3">
            <div class="col-12">
              <input type="text" id="editPhone" class="form-control" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç—Ä–∏–º—É–≤–∞—á–∞ *" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
            </div>
            <div class="col-12">
              <select id="editCity" class="form-select" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
                <option value="">–ú—ñ—Å—Ç–æ</option>
                {% if cities and cities|length > 0 %}
                    {% for city in cities %}
                        <option value="{{ city.value }}">{{ city.value }}</option>
                    {% endfor %}
                {% else %}
                    <option disabled>–î–æ–¥–∞–π—Ç–µ –º—ñ—Å—Ç–∞ —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö</option>
                {% endif %}
              </select>
            </div>
            <div class="col-12 d-flex align-items-center gap-2">
              <input class="form-check-input" type="checkbox" id="editIsPickup" style="margin-top:0;">
              <label class="form-check-label text-secondary small" for="editIsPickup" style="margin-bottom:0;">–°–∞–º–æ–≤–∏–≤—ñ–∑</label>
            </div>
            <div class="col-12">
              <input type="text" id="editStreet" class="form-control" placeholder="–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ *" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
            </div>
            <div class="col-12">
              <select id="editDeliveryType" class="form-select" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
                <option value="">–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</option>
                {% if delivery_types and delivery_types|length > 0 %}
                    {% for t in delivery_types %}
                        <option value="{{ t.value }}">{{ t.value }}</option>
                    {% endfor %}
                {% else %}
                    <option disabled>–î–æ–¥–∞–π—Ç–µ —Ç–∏–ø–∏ —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö</option>
                {% endif %}
              </select>
            </div>
            <div class="col-12">
              <select id="editSize" class="form-select" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
                <option value="">–†–æ–∑–º—ñ—Ä</option>
                {% if sizes and sizes|length > 0 %}
                    {% for s in sizes %}
                        <option value="{{ s.value }}">{{ s.value }}</option>
                    {% endfor %}
                {% else %}
                    <option disabled>–î–æ–¥–∞–π—Ç–µ —Ä–æ–∑–º—ñ—Ä–∏ —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö</option>
                {% endif %}
              </select>
            </div>
            <div class="col-12">
              <input type="date" id="editDeliveryDate" class="form-control" placeholder="–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ *" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
            </div>
            <div class="col-6">
              <input type="time" id="editTimeFrom" class="form-control" placeholder="–ß–∞—Å –∑" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
            </div>
            <div class="col-6">
              <input type="time" id="editTimeTo" class="form-control" placeholder="–ß–∞—Å –¥–æ" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
            </div>
            <div class="col-12">
              <select id="editStatus" class="form-select" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
                <option value="–û—á—ñ–∫—É—î">–û—á—ñ–∫—É—î</option>
                <option value="–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ">–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ</option>
                <option value="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</option>
                <option value="–°–∫–∞—Å–æ–≤–∞–Ω–æ">–°–∫–∞—Å–æ–≤–∞–Ω–æ</option>
                <option value="–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞">–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞</option>
              </select>
            </div>
            <div class="col-12">
              <textarea id="editComment" class="form-control" rows="2" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" maxlength="1000" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;"></textarea>
            </div>
            <div class="col-12">
              <textarea id="editPreferences" class="form-control" rows="2" placeholder="–ü–æ–±–∞–∂–∞–Ω–Ω—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" maxlength="1000" style="background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;"></textarea>
            </div>
          </div>
          
          <!-- –°–µ–∫—Ü—ñ—è –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫ -->
          <div id="future-deliveries-section" class="mt-4" style="display: none;">
            <hr class="my-3">
            <h6 class="mb-3 text-secondary">–ù–∞—Å—Ç—É–ø–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ü—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</h6>
            <div id="future-deliveries-edit-list" class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background: #f8f9fa;">
              <!-- –¢—É—Ç –±—É–¥—É—Ç—å –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏—Å—è –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between align-items-center" style="background:#fff; border-top:none; border-radius:0 0 18px 18px; padding: 18px 28px;">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal" style="border-radius:8px; border:1.5px solid #e3eafc; color:#23272f; font-weight:500;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button type="button" class="btn btn-primary" id="saveDeliveryBtn" style="border-radius:8px; font-weight:500; min-width:120px;">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmStatusModal" tabindex="-1" aria-labelledby="confirmStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmStatusModalLabel">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        –ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ <b>–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</b>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ù—ñ</button>
        <button type="button" class="btn btn-success" id="confirmDeliveredBtn">–¢–∞–∫</button>
      </div>
    </div>
  </div>
</div>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addressModalLabel">–ü–æ–≤–Ω–∞ –∞–¥—Ä–µ—Å–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="addressModalBody">
      </div>
    </div>
  </div>
</div>

<!-- Modal –¥–ª—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫—É—Ä'—î—Ä–∞ (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ assign_deliveries.html) -->
<div class="modal fade" id="assignCourierModal" tabindex="-1" aria-labelledby="assignCourierModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="assignCourierForm">
        <div class="modal-header">
          <h5 class="modal-title" id="assignCourierModalLabel">–í–∏–±–µ—Ä—ñ—Ç—å –∫—É—Ä'—î—Ä–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <select id="courierSelect" class="form-select mb-3" required>
            <option value="">–û–±–µ—Ä—ñ—Ç—å –∫—É—Ä'—î—Ä–∞</option>
            {% for courier in couriers %}
              <option value="{{ courier.id }}">{{ courier.name }}</option>
            {% endfor %}
          </select>
          <div id="selected-addresses" class="mb-2"></div>
          <div id="assign-error" class="alert alert-danger d-none mt-2"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal –¥–ª—è –∑–º—ñ–Ω–∏ –¥–∞—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
<div class="modal fade" id="changeDeliveryDateModal" tabindex="-1" aria-labelledby="changeDeliveryDateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changeDeliveryDateModalLabel">–ó–º—ñ–Ω–∞ –¥–∞—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>–ö–ª—ñ—î–Ω—Ç:</strong> <span id="client-info"></span>
          </div>
          <div class="col-md-6">
            <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="phone-info"></span>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">–ù–æ–≤–∞ –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
          <input type="date" class="form-control" id="newDeliveryDate" required>
        </div>
        
        <div class="mb-3">
          <h6>–ù–∞—Å—Ç—É–ø–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ü—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</h6>
          <div id="future-deliveries-list" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
            <!-- –¢—É—Ç –±—É–¥—É—Ç—å –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏—Å—è –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
          </div>
        </div>
        
        <div id="date-change-error" class="alert alert-danger d-none mt-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button type="button" class="btn btn-primary" id="saveDeliveryDateBtn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<style>
.future-delivery-card.changed {
  background: #fffbe6;
  border-color: #ffc107 !important;
  transition: background 0.2s;
}
.future-delivery-card:hover {
  box-shadow: 0 2px 8px #ffe082;
}
.future-delivery-card {
  min-height: 120px;
  transition: background 0.2s, border-color 0.2s;
}
.unpaid-row {
  background: #ffeaea !important;
  position: relative;
}
.unpaid-row td:first-child {
  border-left: 6px solid #dc3545 !important; /* —Ç–µ–º–Ω–æ-—á–µ—Ä–≤–æ–Ω–∏–π —è–∫ bg-danger */
}
#column-settings-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 40px;
  background: #fff;
  border: 1px solid #ccc;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  z-index: 1000;
  min-width: 220px;
  padding: 12px 16px;
  border-radius: 8px;
}
#column-settings-menu label {
  display: flex;
  align-items: center;
  margin-bottom: 6px;
  cursor: pointer;
}
#column-settings-menu input[type="checkbox"] {
  margin-right: 8px;
}
#column-settings-btn {
  background: none;
  border: none;
  cursor: pointer;
  margin-bottom: 8px;
}
/* –ó–±—ñ–ª—å—à—É—î–º–æ —à—Ä–∏—Ñ—Ç–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ –¥–æ—Å—Ç–∞–≤–æ–∫ */
.table th, .table td {
  font-size: 1.18rem;
  border-right: 2px solid #b5c9e6 !important;
  text-align: center;
}
.table thead th {
  font-size: 1.22rem;
  font-weight: 600;
}
.table th:last-child, .table td:last-child {
  border-right: none !important;
}
/* –ì—Ä—É–ø–æ–≤—ñ —Ä—è–¥–∫–∏ –∑ –¥–∞—Ç–æ—é */
tbody tr > td[colspan] > div {
  font-size: 1.18rem !important;
}
.tag {
  display: inline-block;
  background: #f3f6fa;
  color: #23272f;
  border-radius: 8px;
  padding: 2px 10px;
  font-size: 0.95rem;
  margin-right: 4px;
  font-weight: 500;
  letter-spacing: 0.01em;
  border: 1.5px solid #e3eafc;
}
.tag-hard { background: #ffeae5; color: #d97a6c; border-color: #f7d3cb; }
.tag-medium { background: #fff7e0; color: #bfa14a; border-color: #f7e7b3; }
.tag-easy { background: #e7fbe7; color: #5a9c6e; border-color: #c6e7c6; }
.table th {
  background: #e0edfa !important;
  color: #1565c0 !important;
  font-weight: 600 !important;
}
.table td {
  border-bottom: 1.5px solid #e3eafc !important;
}
.table tbody tr:last-child td {
  border-bottom: none !important;
}
.table tbody tr:nth-child(even):not(.unpaid-row) td {
  background: #f7f8fa !important;
}
.table tbody tr:nth-child(odd):not(.unpaid-row) td {
  background: #fff !important;
}
.btn-primary.active-week {
  background: #1976d2 !important;
  color: #fff !important;
  font-weight: 700;
  box-shadow: 0 2px 8px #b5c9e6;
  border: 2px solid #1565c0 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterForm = document.getElementById('delivery-filter-form');
  // --- –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø–æ —Å—Ç–∞—Ç—É—Å—É —Ç–∞ –¥–∞—Ç—ñ (frontend) ---
  const filterDate = document.getElementById('filter-date');
  const filterStatus = document.getElementById('filter-status');
  const applyBtn = document.getElementById('apply-date-btn');
  const resetBtn = document.getElementById('reset-all-btn');
  const tableRows = document.querySelectorAll('tbody tr');

  function filterTable() {
    const dateVal = filterDate ? filterDate.value : '';
    const statusVal = filterStatus ? filterStatus.value : '';
    tableRows.forEach(row => {
      let show = true;
      if (dateVal) {
        const dateCell = row.querySelector('td:nth-child(9)');
        // –ü–æ—Ä—ñ–≤–Ω—é—î–º–æ –¥–∞—Ç–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–¥.–º–º
        const rowDate = dateCell ? dateCell.textContent.trim() : '';
        const jsDate = new Date(dateVal);
        const formatted = jsDate.toLocaleDateString('uk-UA', {day:'2-digit', month:'2-digit'});
        if (rowDate !== formatted) show = false;
      }
      if (statusVal) {
        if (row.getAttribute('data-status') !== statusVal) show = false;
      }
      row.style.display = show ? '' : 'none';
    });
  }

  if (filterStatus) filterStatus.addEventListener('change', filterTable);
  if (filterDate) filterDate.addEventListener('change', filterTable);
  if (resetBtn) {
    resetBtn.addEventListener('click', function() {
      if (filterDate) filterDate.value = '';
      if (filterStatus) filterStatus.value = '';
      filterTable();
    });
  }
  if (applyBtn) applyBtn.addEventListener('click', filterTable);
  
  // --- –õ–æ–≥—ñ–∫–∞ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ç–∏–∂–Ω—è ---
  const currentWeekBtn = document.getElementById('current-week-btn');
  const nextWeekBtn = document.getElementById('next-week-btn');
  
  function getFinancialWeekDates(offset = 0) {
    const today = new Date();
    const currentDay = today.getDay(); // 0 = –ù–µ–¥—ñ–ª—è, 6 = –°—É–±–æ—Ç–∞

    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞–π–±–ª–∏–∂—á—É –ø–æ–ø–µ—Ä–µ–¥–Ω—é/–ø–æ—Ç–æ—á–Ω—É —Å—É–±–æ—Ç—É (6)
    let daysSinceSaturday = (currentDay - 6 + 7) % 7;
    const saturday = new Date(today);
    saturday.setDate(today.getDate() - daysSinceSaturday + (offset * 7));

    // –ö—ñ–Ω–µ—Ü—å —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ç–∏–∂–Ω—è (–Ω–∞—Å—Ç—É–ø–Ω–∞ –ø'—è—Ç–Ω–∏—Ü—è, –≤–∫–ª—é—á–Ω–æ)
    const nextFriday = new Date(saturday);
    nextFriday.setDate(saturday.getDate() + 6); // +6 –¥–Ω—ñ–≤ = –Ω–∞—Å—Ç—É–ø–Ω–∞ –ø'—è—Ç–Ω–∏—Ü—è

    return {
      start: saturday.toISOString().split('T')[0],
      end: nextFriday.toISOString().split('T')[0]
    };
  }
  
  if (currentWeekBtn) {
    currentWeekBtn.addEventListener('click', function() {
      // –û—á–∏—â–∞—î–º–æ —ñ–Ω—à—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
      if (filterDate) filterDate.value = '';
      if (filterStatus) filterStatus.value = '';
      
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ —Ñ—ñ–ª—å—Ç—Ä–æ–º –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ç–∏–∂–Ω—è
      const url = new URL(window.location);
      url.searchParams.set('financial_week', '0');
      url.searchParams.delete('date');
      url.searchParams.delete('status');
      window.location.href = url.toString();
    });
  }
  
  if (nextWeekBtn) {
    nextWeekBtn.addEventListener('click', function() {
      // –û—á–∏—â–∞—î–º–æ —ñ–Ω—à—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
      if (filterDate) filterDate.value = '';
      if (filterStatus) filterStatus.value = '';
      
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ —Ñ—ñ–ª—å—Ç—Ä–æ–º –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ç–∏–∂–Ω—è
      const url = new URL(window.location);
      url.searchParams.set('financial_week', '1');
      url.searchParams.delete('date');
      url.searchParams.delete('status');
      window.location.href = url.toString();
    });
  }
  
  // –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
  const resetAllBtn = document.getElementById('reset-all-btn');
  if (resetAllBtn) {
    resetAllBtn.addEventListener('click', function() {
      const url = new URL(window.location);
      url.search = '';
      window.location.href = url.toString();
    });
  }

  // --- –û–±—Ä–æ–±–∫–∞ Enter –¥–ª—è –ø–æ—à—É–∫—É –∑–∞ Instagram —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º ---
  const instagramInput = filterForm.querySelector('input[name="client_instagram"]');
  const phoneInput = filterForm.querySelector('input[name="recipient_phone"]');
  
  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º–∏
  function submitFilterForm() {
    filterForm.submit();
  }
  
  // –û–±—Ä–æ–±–∫–∞ Enter —É –ø–æ–ª—ñ Instagram
  if (instagramInput) {
    instagramInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitFilterForm();
      }
    });
  }
  
  // –û–±—Ä–æ–±–∫–∞ Enter —É –ø–æ–ª—ñ —Ç–µ–ª–µ—Ñ–æ–Ω—É
  if (phoneInput) {
    phoneInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitFilterForm();
      }
    });
  }

  // --- –ê–≤—Ç–æ—Å–∞–±–º—ñ—Ç –ø—Ä–∏ –∑–º—ñ–Ω—ñ –¥–∞—Ç–∏ ---
  if (filterDate && filterForm) {
    filterDate.addEventListener('change', function() {
      filterForm.submit();
    });
  }

  // --- –ê–≤—Ç–æ—Å–∞–±–º—ñ—Ç –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–∞—Ç—É—Å—É ---
  if (filterStatus && filterForm) {
    filterStatus.addEventListener('change', function() {
      filterForm.submit();
    });
  }

  // --- –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –∑–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É ---
  let currentDeliveryId = null;
  const assignModalElement = document.getElementById('assignCourierModal');
  const confirmModalElement = document.getElementById('confirmStatusModal');
  const assignModal = assignModalElement ? new bootstrap.Modal(assignModalElement) : null;
  const confirmModal = confirmModalElement ? new bootstrap.Modal(confirmModalElement) : null;

  document.querySelectorAll('.delivery-status').forEach(span => {
    span.addEventListener('click', function() {
      const status = this.dataset.status;
      currentDeliveryId = this.dataset.id;
      if (status === '–û—á—ñ–∫—É—î' && assignModal) {
        const courierSelect = document.getElementById('courierSelect');
        const assignError = document.getElementById('assign-error');
        if (courierSelect) courierSelect.value = '';
        if (assignError) assignError.classList.add('d-none');
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∞–¥—Ä–µ—Å—É –¥–ª—è —Ü—ñ—î—ó –¥–æ—Å—Ç–∞–≤–∫–∏
        const row = span.closest('tr');
        const city = row.querySelector('td:nth-child(2)').textContent.trim();
        const address = row.querySelector('td:nth-child(3)').textContent.trim();
        const date = row.querySelector('td:nth-child(9)').textContent.trim();
        const selectedAddresses = document.getElementById('selected-addresses');
        if (selectedAddresses) {
          selectedAddresses.innerHTML = `<b>–í–∏ –ø—Ä–∏–∑–Ω–∞—á–∞—î—Ç–µ –∫—É—Ä º—î—Ä–∞ –Ω–∞ –∞–¥—Ä–µ—Å—É:</b><ul><li>${city}, ${address} ‚Äî ${date}</li></ul>`;
        }
        assignModal.show();
      } else if (status === '–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ' && confirmModal) {
        confirmModal.show();
      }
    });
  });

  // –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫—É—Ä'—î—Ä–∞ (submit)
  const assignCourierForm = document.getElementById('assignCourierForm');
  if (assignCourierForm) {
    assignCourierForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const courierId = document.getElementById('courierSelect') ? document.getElementById('courierSelect').value : '';
      const errorDiv = document.getElementById('assign-error');
      if (errorDiv) errorDiv.classList.add('d-none');
      if (!courierId) {
        if (errorDiv) {
          errorDiv.textContent = '–û–±–µ—Ä—ñ—Ç—å –∫—É—Ä º—î—Ä–∞!';
          errorDiv.classList.remove('d-none');
        }
        return;
      }
      fetch(`/deliveries/assign-courier`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({delivery_ids: [currentDeliveryId], courier_id: courierId})
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          if (errorDiv) {
            errorDiv.textContent = data.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ!';
            errorDiv.classList.remove('d-none');
          }
        }
      });
    });
  }

  // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è "–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ?"
  const confirmDeliveredBtn = document.getElementById('confirmDeliveredBtn');
  if (confirmDeliveredBtn) {
    confirmDeliveredBtn.onclick = function() {
      fetch(`/deliveries/${currentDeliveryId}/status`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'})
      }).then(r => r.json()).then(data => {
        if (data.success) {
          location.reload();
        }
      });
    }
  }

  // --- –õ–æ–≥—ñ–∫–∞ –¥–ª—è –∞–¥—Ä–µ—Å–∏ (–ø–æ–ø–∞–ø) ---
  const addressModalElement = document.getElementById('addressModal');
  const addressModal = addressModalElement ? new bootstrap.Modal(addressModalElement) : null;
  document.querySelectorAll('.address-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const city = this.dataset.city || '';
      const street = this.dataset.street || '';
      const building = this.dataset.building || '';
      const entrance = this.dataset.entrance || '';
      let html = `<b>–ú—ñ—Å—Ç–æ:</b> ${city}<br><b>–í—É–ª–∏—Ü—è:</b> ${street}<br><b>–ë—É–¥–∏–Ω–æ–∫:</b> ${building}`;
      if (entrance) html += `<br><b>–ü—ñ–¥'—ó–∑–¥:</b> ${entrance}`;
      const addressModalBody = document.getElementById('addressModalBody');
      if (addressModalBody) {
        addressModalBody.innerHTML = html;
      }
      if (addressModal) {
        addressModal.show();
      }
    });
  });

  // --- –õ–æ–≥—ñ–∫–∞ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏ (double click –ø–æ —Ä—è–¥–∫—É) ---
  const editModalElement = document.getElementById('editDeliveryModal');
  const editModal = editModalElement ? new bootstrap.Modal(editModalElement) : null;
  let currentId = null;
  
  // –°–∞–º–æ–≤–∏–≤—ñ–∑ - –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è –∞–¥—Ä–µ—Å–∏
  const editIsPickupCheckbox = document.getElementById('editIsPickup');
  const editStreetInput = document.getElementById('editStreet');
  
  if (editIsPickupCheckbox && editStreetInput) {
    editIsPickupCheckbox.addEventListener('change', function() {
      if (this.checked) {
        editStreetInput.value = '';
        editStreetInput.disabled = true;
        editStreetInput.classList.add('input-disabled');
      } else {
        editStreetInput.disabled = false;
        editStreetInput.classList.remove('input-disabled');
      }
    });
  }
  
  if (!editModal) {
    console.error('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
  }
  
  document.querySelectorAll('tbody tr').forEach(row => {
    row.addEventListener('dblclick', function() {
      console.log('–î–∞–±–ª –∫–ª—ñ–∫ —Å–ø—Ä–∞—Ü—é–≤–∞–≤');
      const id = this.children[0].innerText;
      console.log('ID –¥–æ—Å—Ç–∞–≤–∫–∏:', id);
      currentId = id;
      
      fetch(`/deliveries/${id}`)
        .then(r => {
          console.log('Fetch response status:', r.status);
          if (!r.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–∫–∏');
          }
          return r.json();
        })
        .then(data => {
          console.log('–û—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ:', data);
          document.getElementById('editDeliveryId').value = data.id;
          document.getElementById('editPhone').value = data.phone || '';
          document.getElementById('editCity').value = data.city || '';
          document.getElementById('editIsPickup').checked = data.is_pickup || false;
          document.getElementById('editStreet').value = data.street || '';
          document.getElementById('editDeliveryType').value = data.delivery_type || '';
          document.getElementById('editSize').value = data.size || '';
          document.getElementById('editDeliveryDate').value = data.delivery_date || '';
          document.getElementById('editTimeFrom').value = data.time_from || '';
          document.getElementById('editTimeTo').value = data.time_to || '';
          document.getElementById('editStatus').value = data.status || '–û—á—ñ–∫—É—î';
          document.getElementById('editComment').value = data.comment || '';
          document.getElementById('editPreferences').value = data.preferences || '';
          // --- –ü–û–ö–ê–ó/–°–•–û–í–ê–¢–ò –ö–ù–û–ü–ö–£ –ü–†–û–î–û–í–ñ–ï–ù–ù–Ø –ü–Ü–î–ü–ò–°–ö–ò ---
          const extendBtn = document.getElementById('extendDeliverySubscriptionBtn');
          const status = document.getElementById('editStatus').value;
          const deliveryType = document.getElementById('editDeliveryType').value;
          if (
            status === '–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞' &&
            ['Weekly', 'Monthly', 'Bi-weekly'].includes(deliveryType)
          ) {
            extendBtn.style.display = '';
          } else {
            extendBtn.style.display = 'none';
          }
          console.log('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è');
          
          // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –º–æ–¥–∞–ª–∫–∏
          loadFutureDeliveries(data.id);
          
          if (editModal) {
            editModal.show();
          } else {
            console.error('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
            alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞');
          }
        })
        .catch(error => {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–∫–∏');
        });
    });
  });
  
  // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏
  const saveDeliveryBtn = document.getElementById('saveDeliveryBtn');
  if (saveDeliveryBtn) {
    saveDeliveryBtn.addEventListener('click', function() {
      if (!currentId) {
        alert('–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è');
        return;
      }
      
      // –ó–±–∏—Ä–∞—î–º–æ –∑–º—ñ–Ω–∏ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫
      const changedDates = {};
      document.querySelectorAll('.future-delivery-date-input').forEach(input => {
        const deliveryId = input.dataset.deliveryId;
        const dateValue = input.value;
        if (dateValue && changedFutureDeliveries.has(parseInt(deliveryId))) {
          changedDates[deliveryId] = dateValue;
        }
      });
      
      const payload = {
        phone: document.getElementById('editPhone').value,
        street: document.getElementById('editStreet').value,
        delivery_type: document.getElementById('editDeliveryType').value,
        size: document.getElementById('editSize').value,
        delivery_date: document.getElementById('editDeliveryDate').value,
        time_from: document.getElementById('editTimeFrom').value,
        time_to: document.getElementById('editTimeTo').value,
        status: document.getElementById('editStatus').value,
        is_pickup: document.getElementById('editIsPickup').checked,
        comment: document.getElementById('editComment').value,
        preferences: document.getElementById('editPreferences').value,
        changed_dates: changedDates // –î–æ–¥–∞—î–º–æ –∑–º—ñ–Ω–∏ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫
      };
      
      fetch(`/deliveries/${currentId}/edit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r => {
        if (!r.ok) {
          throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
        }
        return r.json();
      })
              .then(data => {
          if (data.success) {
            editModal.hide();
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            const successMessage = changedFutureDeliveries.size > 0 
              ? `–ó–±–µ—Ä–µ–∂–µ–Ω–æ –∑–º—ñ–Ω–∏ –¥–ª—è ${changedFutureDeliveries.size + 1} –¥–æ—Å—Ç–∞–≤–æ–∫` 
              : '–ó–º—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ';
            alert(successMessage);
            location.reload();
          } else {
            alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
          }
        })
      .catch(error => {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏');
      });
    });
  } else {
    console.error('–ö–Ω–æ–ø–∫–∞ saveDeliveryBtn –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
  }
  
  // --- –õ–æ–≥—ñ–∫–∞ –¥–ª—è –∑–º—ñ–Ω–∏ –¥–∞—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ ---
  const changeDateModalElement = document.getElementById('changeDeliveryDateModal');
  const changeDateModal = changeDateModalElement ? new bootstrap.Modal(changeDateModalElement) : null;
  let currentDeliveryIdForDateChange = null;
  let changedDeliveries = new Set(); // –î–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–µ–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫
  let changedFutureDeliveries = new Set(); // –î–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–µ–Ω–∏—Ö –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫ –≤ –º–æ–¥–∞–ª—Ü—ñ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  
  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫ –≤ –º–æ–¥–∞–ª—Ü—ñ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  function loadFutureDeliveries(deliveryId) {
    fetch(`/deliveries/${deliveryId}/future-deliveries`)
      .then(r => r.json())
      .then(futureDeliveries => {
        const futureSection = document.getElementById('future-deliveries-section');
        const futureList = document.getElementById('future-deliveries-edit-list');
        
        if (futureDeliveries.length === 0) {
          futureSection.style.display = 'none';
        } else {
          futureSection.style.display = 'block';
          let html = '<div class="row">';
          futureDeliveries.forEach(delivery => {
            const isChanged = changedFutureDeliveries.has(delivery.id);
            html += `
              <div class="col-md-6 mb-2">
                <div class="card future-delivery-card ${isChanged ? 'changed border-warning' : 'border-light'}" style="min-height: 120px;">
                  <div class="card-body p-2 d-flex flex-column justify-content-between">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <div>
                        <span class="text-muted small">ID: ${delivery.id}</span>
                      </div>
                      <span class="badge ${delivery.status === '–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞' ? 'bg-danger' : 'bg-secondary'}">${delivery.status}</span>
                    </div>
                    <div class="mb-2">
                      <span class="fw-bold fs-5">${delivery.delivery_date}</span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <input type="date" class="form-control form-control-sm future-delivery-date-input" 
                             data-delivery-id="${delivery.id}" 
                             value="${delivery.delivery_date}"
                             style="width: 140px;">
                      <span class="badge bg-warning text-dark ms-1" title="–î–∞—Ç–∞ –∑–º—ñ–Ω–µ–Ω–∞" style="display: ${isChanged ? '' : 'none'};">–ó–º—ñ–Ω–µ–Ω–æ</span>
                      <i class="bi bi-check-circle-fill text-success ms-1" style="display: ${isChanged ? '' : 'none'};"></i>
                    </div>
                    <small class="text-muted">–ù–æ–≤–∞ –¥–∞—Ç–∞</small>
                  </div>
                </div>
              </div>
            `;
          });
          html += '</div>';
          futureList.innerHTML = html;
          
          // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∑–º—ñ–Ω–∏ –¥–∞—Ç –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫
          document.querySelectorAll('.future-delivery-date-input').forEach(input => {
            input.addEventListener('change', function() {
              const deliveryId = this.dataset.deliveryId;
              changedFutureDeliveries.add(parseInt(deliveryId));
              const card = this.closest('.future-delivery-card');
              card.classList.add('changed', 'border-warning');
              // –ü–æ–∫–∞–∑–∞—Ç–∏ –±–µ–π–¥–∂ —ñ —ñ–∫–æ–Ω–∫—É
              const badge = card.querySelector('.badge.bg-warning');
              if (badge) badge.style.display = '';
              const checkIcon = card.querySelector('.bi-check-circle-fill');
              if (checkIcon) checkIcon.style.display = '';
            });
          });
        }
      })
      .catch(error => {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫:', error);
      });
  }
  
  // –û–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ –¥–∞—Ç–∏ –≤ –º–æ–¥–∞–ª—Ü—ñ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  document.getElementById('editDeliveryDate').addEventListener('change', function() {
    const deliveryId = document.getElementById('editDeliveryId').value;
    if (deliveryId) {
      // –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –¥–∞—Ç–∏
      loadFutureDeliveries(deliveryId);
    }
  });
  
  // –û—á–∏—â–µ–Ω–Ω—è –∑–º—ñ–Ω–µ–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –º–æ–¥–∞–ª–∫–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  document.getElementById('editDeliveryModal').addEventListener('hidden.bs.modal', function() {
    changedFutureDeliveries.clear();
    document.getElementById('future-deliveries-section').style.display = 'none';
  });
  
  // –ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ –ø–æ –¥–∞—Ç—ñ –¥–æ—Å—Ç–∞–≤–∫–∏
  document.querySelectorAll('.delivery-date-cell').forEach(cell => {
    cell.addEventListener('dblclick', function(event) {
      event.stopPropagation(); // –ù–µ –¥–∞—î–º–æ –ø–æ–¥—ñ—ó –ø—ñ–¥–Ω—è—Ç–∏—Å—å –¥–æ tr
      const deliveryId = this.dataset.deliveryId;
      currentDeliveryIdForDateChange = deliveryId;
      
      // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏
      fetch(`/deliveries/${deliveryId}`)
        .then(r => r.json())
        .then(data => {
          // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞
          document.getElementById('client-info').textContent = data.client_instagram || '–ù–µ–≤—ñ–¥–æ–º–æ';
          document.getElementById('phone-info').textContent = data.phone || '–ù–µ–≤—ñ–¥–æ–º–æ';
          
          // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É
          document.getElementById('newDeliveryDate').value = data.delivery_date;
          
          // –û—Ç—Ä–∏–º—É—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ü—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
          return fetch(`/deliveries/${deliveryId}/future-deliveries`);
        })
        .then(r => r.json())
        .then(futureDeliveries => {
          const futureList = document.getElementById('future-deliveries-list');
          if (futureDeliveries.length === 0) {
            futureList.innerHTML = '<p class="text-muted">–ù–µ–º–∞—î –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫</p>';
          } else {
            let html = '<div class="row">';
            futureDeliveries.forEach(delivery => {
              const isChanged = changedDeliveries.has(delivery.id);
              html += `
                <div class="col-md-6 mb-2">
                  <div class="card ${isChanged ? 'border-warning' : 'border-light'}">
                    <div class="card-body p-2">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <small class="text-muted">ID: ${delivery.id}</small><br>
                          <strong>${delivery.delivery_date}</strong>
                        </div>
                        <div>
                          <input type="date" class="form-control form-control-sm future-date-input" 
                                 data-delivery-id="${delivery.id}" 
                                 value="${delivery.delivery_date}"
                                 style="width: 140px;">
                          ${isChanged ? '<span class="badge bg-warning text-dark ms-1">–ó–º—ñ–Ω–µ–Ω–æ</span>' : ''}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            });
            html += '</div>';
            futureList.innerHTML = html;
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∑–º—ñ–Ω–∏ –¥–∞—Ç –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫
            document.querySelectorAll('.future-date-input').forEach(input => {
              input.addEventListener('change', function() {
                const deliveryId = this.dataset.deliveryId;
                changedDeliveries.add(deliveryId);
                this.closest('.card').classList.remove('border-light');
                this.closest('.card').classList.add('border-warning');
                
                // –î–æ–¥–∞—î–º–æ –±–µ–π–¥–∂ "–ó–º—ñ–Ω–µ–Ω–æ"
                const cardBody = this.closest('.card-body');
                const existingBadge = cardBody.querySelector('.badge');
                if (!existingBadge) {
                  const badge = document.createElement('span');
                  badge.className = 'badge bg-warning text-dark ms-1';
                  badge.textContent = '–ó–º—ñ–Ω–µ–Ω–æ';
                  this.parentNode.appendChild(badge);
                }
              });
            });
          }
          
          if (changeDateModal) {
            changeDateModal.show();
          }
        })
        .catch(error => {
          console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:', error);
          alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–∫–∏');
        });
    });
  });
  
  // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–µ–Ω–∏—Ö –¥–∞—Ç
  const saveDeliveryDateBtn = document.getElementById('saveDeliveryDateBtn');
  if (saveDeliveryDateBtn) {
    saveDeliveryDateBtn.addEventListener('click', function() {
      if (!currentDeliveryIdForDateChange) {
        alert('–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è –∑–º—ñ–Ω–∏');
        return;
      }
      
      const newDate = document.getElementById('newDeliveryDate').value;
      if (!newDate) {
        alert('–í–∏–±–µ—Ä—ñ—Ç—å –Ω–æ–≤—É –¥–∞—Ç—É –¥–æ—Å—Ç–∞–≤–∫–∏');
        return;
      }
      
      // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –∑–º—ñ–Ω–µ–Ω—ñ –¥–∞—Ç–∏
      const changedDates = {};
      changedDates[currentDeliveryIdForDateChange] = newDate;
      
      document.querySelectorAll('.future-date-input').forEach(input => {
        const deliveryId = input.dataset.deliveryId;
        const dateValue = input.value;
        if (dateValue && dateValue !== input.defaultValue) {
          changedDates[deliveryId] = dateValue;
        }
      });
      
      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–º—ñ–Ω–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      fetch(`/deliveries/${currentDeliveryIdForDateChange}/change-dates`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({changed_dates: changedDates})
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          changeDateModal.hide();
          location.reload();
        } else {
          const errorDiv = document.getElementById('date-change-error');
          errorDiv.textContent = data.error || '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞—Ç';
          errorDiv.classList.remove('d-none');
        }
      })
      .catch(error => {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞—Ç –¥–æ—Å—Ç–∞–≤–∫–∏');
      });
    });
  }
  
  let pendingExtendDeliveryId = null;
  const extendDeliveryBtn = document.getElementById('extendDeliverySubscriptionBtn');
  const editDeliveryModal = document.getElementById('editDeliveryModal');

  extendDeliveryBtn.addEventListener('click', function() {
    pendingExtendDeliveryId = document.getElementById('editDeliveryId').value;
    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏
    const editModal = bootstrap.Modal.getInstance(editDeliveryModal);
    if (editModal) editModal.hide();
  });

  // –°–ª—É—Ö–∞—î–º–æ –ø–æ–¥—ñ—é –ø–æ–≤–Ω–æ–≥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏
  editDeliveryModal.addEventListener('hidden.bs.modal', function handler() {
    if (!pendingExtendDeliveryId) return;
    // –ü—ñ—Å–ª—è –ø–æ–≤–Ω–æ–≥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è ‚Äî —Ä–æ–±–∏–º–æ AJAX-–∑–∞–ø–∏—Ç —ñ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –Ω–æ–≤—É –º–æ–¥–∞–ª–∫—É
    fetch(`/orders/extend-form-from-delivery/${pendingExtendDeliveryId}`)
      .then(r => r.text())
      .then(html => {
        let container = document.getElementById('dynamic-modal-container');
        if (!container) {
          container = document.createElement('div');
          container.id = 'dynamic-modal-container';
          document.body.appendChild(container);
        }
        container.innerHTML = html;
        const newModal = new bootstrap.Modal(document.getElementById('extendOrderModal'));
        newModal.show();
        pendingExtendDeliveryId = null;
        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ —Å–∞–±–º—ñ—Ç—É –ø—ñ—Å–ª—è –≤—Å—Ç–∞–≤–∫–∏ –º–æ–¥–∞–ª–∫–∏
        const form = document.getElementById('extendOrderForm');
        if (form) {
          form.onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const response = await fetch('/orders/new', {
              method: 'POST',
              body: formData,
              headers: {'X-Requested-With': 'XMLHttpRequest'}
            });
            const data = await response.json();
            if (data.success) {
              bootstrap.Modal.getInstance(document.getElementById('extendOrderModal')).hide();
              location.reload();
            } else {
              alert(data.error || '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è!');
            }
          };
        }
      });
  });

  // === JS –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≤–∏–¥–∏–º—ñ—Å—Ç—é –∫–æ–ª–æ–Ω–æ–∫ ===
  const STORAGE_KEY = 'delivery_columns_v1';
  function getColumnSettings() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    } catch {
      return {};
    }
  }
  function setColumnSettings(settings) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
  }
  function applyColumnSettings() {
    const settings = getColumnSettings();
    // th
    document.querySelectorAll('table thead th').forEach(th => {
      const col = th.dataset.col;
      th.style.display = (settings[col] === false) ? 'none' : '';
    });
    // td
    document.querySelectorAll('table tbody tr').forEach(tr => {
      tr.querySelectorAll('td').forEach(td => {
        const col = td.dataset.col;
        td.style.display = (settings[col] === false) ? 'none' : '';
      });
    });
    // —á–µ–∫–±–æ–∫—Å–∏
    document.querySelectorAll('.column-toggle').forEach(cb => {
      cb.checked = settings[cb.dataset.col] !== false;
    });
  }
  document.getElementById('column-settings-btn').onclick = function(e) {
    e.stopPropagation();
    const menu = document.getElementById('column-settings-menu');
    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
  };
  document.getElementById('save-columns').onclick = function() {
    const settings = {};
    document.querySelectorAll('.column-toggle').forEach(cb => {
      settings[cb.dataset.col] = cb.checked;
    });
    setColumnSettings(settings);
    applyColumnSettings();
    document.getElementById('column-settings-menu').style.display = 'none';
  };
  document.addEventListener('click', function(e) {
    const menu = document.getElementById('column-settings-menu');
    if (menu.style.display === 'block' && !menu.contains(e.target) && e.target.id !== 'column-settings-btn') {
      menu.style.display = 'none';
    }
  });
  window.addEventListener('DOMContentLoaded', applyColumnSettings);
  // === /JS –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≤–∏–¥–∏–º—ñ—Å—Ç—é –∫–æ–ª–æ–Ω–æ–∫ ===
});
</script>
{% endblock %} 