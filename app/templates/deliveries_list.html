{% extends 'layout.html' %}
{% block content %}
<h2 class="mb-4">–î–æ—Å—Ç–∞–≤–∫–∏</h2>
<div class="mb-2">
  <strong>–í—Å—å–æ–≥–æ –¥–æ—Å—Ç–∞–≤–æ–∫: {{ deliveries_count }}</strong>
  <small class="text-muted ms-3">üí° –ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ –ø–æ —Ä—è–¥–∫—É –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</small>
</div>
<div class="filter-bar mb-3 w-100">
  <form class="d-flex flex-wrap gap-2 align-items-center w-100" method="get" id="delivery-filter-form">
    <input type="text" name="client_instagram" class="form-control" style="max-width:160px; background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;" placeholder="–ü–æ—à—É–∫ –∑–∞ Instagram –∫–ª—ñ—î–Ω—Ç–∞..." value="{{ request.args.get('client_instagram', '') }}">
    <input type="text" name="recipient_phone" class="form-control" style="max-width:160px; background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;" placeholder="–ü–æ—à—É–∫ –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –æ—Ç—Ä–∏–º—É–≤–∞—á–∞..." value="{{ request.args.get('recipient_phone', '') }}">
    <input type="date" id="filter-date" name="date" class="form-control" style="max-width:170px; background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;" value="{{ selected_date }}">
    <select id="filter-status" name="status" class="form-select" style="max-width:170px; background:#f7f8fa; border-radius:10px; border:1.5px solid #e3eafc; font-size:1.04rem;">
      <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
      <option value="–û—á—ñ–∫—É—î">–û—á—ñ–∫—É—î</option>
      <option value="–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ">–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ</option>
      <option value="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</option>
      <option value="–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞">–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞</option>
    </select>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-sm {% if request.args.get('financial_week') == '0' %}btn-primary{% else %}btn-outline-primary{% endif %}" id="current-week-btn">–ü–æ—Ç–æ—á–Ω–∏–π —Ñ—ñ–Ω. —Ç–∏–∂–¥–µ–Ω—å</button>
      <button type="button" class="btn btn-sm {% if request.args.get('financial_week') == '1' %}btn-primary{% else %}btn-outline-primary{% endif %}" id="next-week-btn">–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ñ—ñ–Ω. —Ç–∏–∂–¥–µ–Ω—å</button>
    </div>
    <div class="ms-auto">
      <button class="btn btn-outline-secondary" id="reset-all-btn" type="button">–°–∫–∏–Ω—É—Ç–∏</button>
    </div>
  </form>
</div>
<table class="table table-bordered table-hover align-middle">
  <thead>
    <tr>
      <th>ID</th>
      <th>–ö–ª—ñ—î–Ω—Ç</th>
      <th>–ê–¥—Ä–µ—Å–∞</th>
      <th>–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</th>
      <th>–†–æ–∑–º—ñ—Ä</th>
      <th>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</th>
      <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
      <th style="width:90px;">–ß–∞—Å</th>
      <th>–î–∞—Ç–∞</th>
      <th>–°—Ç–∞—Ç—É—Å</th>
    </tr>
  </thead>
  <tbody>
    {% for d in deliveries %}
    <tr data-status="{{ d.status }}" style="cursor: pointer;" 
        {% if not d.is_subscription and d.delivery_type in ['Weekly', 'Monthly', 'Bi-weekly'] %}
        class="unpaid-subscription-delivery"
        {% endif %}>
      <td>{{ d.id }}</td>
      <td>{% if d.client and d.client.instagram %}{{ d.client.instagram }}{% else %}‚Äî{% endif %}</td>
      <td>
        {% if d.is_pickup %}
          <span class="tag tag-easy">–°–∞–º–æ–≤–∏–≤—ñ–∑</span>
        {% else %}
          <a href="#" class="address-link" 
             data-street="{{ d.street }}" 
             data-building="{{ d.building_number }}" 
             data-entrance="{{ d.entrance }}"
             style="color:inherit; text-decoration:none; cursor:pointer;">
            {{ d.street }}{% if d.building_number %}, {{ d.building_number }}{% endif %}
          </a>
        {% endif %}
      </td>
      <td>{{ d.phone }}</td>
      <td>{% if d.bouquet_size %}{{ d.bouquet_size }}{% elif d.size %}{{ d.size }}{% else %}-{% endif %}</td>
      <td>
        {{ d.delivery_type }}
        {% if not d.is_subscription and d.delivery_type in ['Weekly', 'Monthly', 'Bi-weekly'] %}
          <span class="badge bg-warning text-dark ms-1" title="–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ - –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É">!</span>
        {% endif %}
      </td>
      <td>{{ d.comment }}</td>
      <td>
        {% if d.time_from and d.time_to %}
          {{ d.time_from }}-{{ d.time_to }}
        {% elif d.time_from and not d.time_to %}
          –∑ {{ d.time_from }}
        {% elif d.time_to and not d.time_from %}
          –¥–æ {{ d.time_to }}
        {% else %}
          &nbsp;
        {% endif %}
      </td>
      <td class="delivery-date-cell" data-delivery-id="{{ d.id }}" style="cursor: pointer;">{{ d.delivery_date.strftime('%d.%m') }}</td>
      <td>
        <span class="delivery-status badge 
          {% if d.status == '–û—á—ñ–∫—É—î' %}bg-secondary
          {% elif d.status == '–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ' %}bg-primary
          {% elif d.status == '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ' %}bg-success
          {% elif d.status == '–ù–µ –æ–ø–ª–∞—á–µ–Ω–∞' %}bg-danger
          {% else %}bg-light text-dark
          {% endif %}"
          data-id="{{ d.id }}" data-status="{{ d.status }}" style="cursor:pointer;">
          {{ d.status }}
        </span>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
{% if deliveries_count > 30 %}
<div class="d-flex justify-content-center align-items-center gap-2">
    <form method="get" style="display:inline;">
        {% for key, value in request.args.items() %}
            {% if key != 'page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button class="btn btn-secondary" name="page" value="{{ prev_page }}" {% if page == 1 %}disabled{% endif %}>–ù–∞–∑–∞–¥</button>
    </form>
    <span class="mx-2">{{ page }}</span>
    <form method="get" style="display:inline;">
        {% for key, value in request.args.items() %}
            {% if key != 'page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button class="btn btn-secondary" name="page" value="{{ next_page }}" {% if not has_next %}disabled{% endif %}>–í–ø–µ—Ä–µ–¥</button>
    </form>
</div>
{% endif %}

<!-- Modal -->
<div class="modal fade" id="editDeliveryModal" tabindex="-1" aria-labelledby="editDeliveryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDeliveryModalLabel">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editDeliveryForm">
          <input type="hidden" name="delivery_id" id="editDeliveryId">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">–ú—ñ—Å—Ç–æ</label>
              <input type="text" class="form-control" id="editCity" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">–í—É–ª–∏—Ü—è</label>
              <input type="text" class="form-control" id="editStreet">
            </div>
            <div class="col-md-3">
              <label class="form-label">‚Ññ –±—É–¥–∏–Ω–∫—É</label>
              <input type="text" class="form-control" id="editBuildingNumber">
            </div>
            <div class="col-md-3">
              <label class="form-label">–ß–∞—Å –∑</label>
              <input type="time" class="form-control" id="editTimeFrom">
            </div>
            <div class="col-md-3">
              <label class="form-label">–ß–∞—Å –¥–æ</label>
              <input type="time" class="form-control" id="editTimeTo">
            </div>
            <div class="col-md-6">
              <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</label>
              <input type="text" class="form-control" id="editPhone">
            </div>
            <div class="col-md-4">
              <label class="form-label">–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
              <input type="date" class="form-control" id="editDeliveryDate">
            </div>
            <div class="col-md-12">
              <label class="form-label">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
              <textarea class="form-control" id="editComment"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button type="button" class="btn btn-primary" id="saveDeliveryBtn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmStatusModal" tabindex="-1" aria-labelledby="confirmStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmStatusModalLabel">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        –ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ <b>–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</b>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ù—ñ</button>
        <button type="button" class="btn btn-success" id="confirmDeliveredBtn">–¢–∞–∫</button>
      </div>
    </div>
  </div>
</div>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addressModalLabel">–ü–æ–≤–Ω–∞ –∞–¥—Ä–µ—Å–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="addressModalBody">
      </div>
    </div>
  </div>
</div>

<!-- Modal –¥–ª—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫—É—Ä'—î—Ä–∞ (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ assign_deliveries.html) -->
<div class="modal fade" id="assignCourierModal" tabindex="-1" aria-labelledby="assignCourierModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="assignCourierForm">
        <div class="modal-header">
          <h5 class="modal-title" id="assignCourierModalLabel">–í–∏–±–µ—Ä—ñ—Ç—å –∫—É—Ä'—î—Ä–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <select id="courierSelect" class="form-select mb-3" required>
            <option value="">–û–±–µ—Ä—ñ—Ç—å –∫—É—Ä'—î—Ä–∞</option>
            {% for courier in couriers %}
              <option value="{{ courier.id }}">{{ courier.name }}</option>
            {% endfor %}
          </select>
          <div id="selected-addresses" class="mb-2"></div>
          <div id="assign-error" class="alert alert-danger d-none mt-2"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal –¥–ª—è –∑–º—ñ–Ω–∏ –¥–∞—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
<div class="modal fade" id="changeDeliveryDateModal" tabindex="-1" aria-labelledby="changeDeliveryDateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changeDeliveryDateModalLabel">–ó–º—ñ–Ω–∞ –¥–∞—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>–ö–ª—ñ—î–Ω—Ç:</strong> <span id="client-info"></span>
          </div>
          <div class="col-md-6">
            <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="phone-info"></span>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">–ù–æ–≤–∞ –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
          <input type="date" class="form-control" id="newDeliveryDate" required>
        </div>
        
        <div class="mb-3">
          <h6>–ù–∞—Å—Ç—É–ø–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ü—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</h6>
          <div id="future-deliveries-list" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
            <!-- –¢—É—Ç –±—É–¥—É—Ç—å –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏—Å—è –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
          </div>
        </div>
        
        <div id="date-change-error" class="alert alert-danger d-none mt-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button type="button" class="btn btn-primary" id="saveDeliveryDateBtn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø–æ —Å—Ç–∞—Ç—É—Å—É —Ç–∞ –¥–∞—Ç—ñ (frontend) ---
  const filterDate = document.getElementById('filter-date');
  const filterStatus = document.getElementById('filter-status');
  const applyBtn = document.getElementById('apply-date-btn');
  const resetBtn = document.getElementById('reset-all-btn');
  const tableRows = document.querySelectorAll('tbody tr');

  function filterTable() {
    const dateVal = filterDate ? filterDate.value : '';
    const statusVal = filterStatus ? filterStatus.value : '';
    tableRows.forEach(row => {
      let show = true;
      if (dateVal) {
        const dateCell = row.querySelector('td:nth-child(9)');
        // –ü–æ—Ä—ñ–≤–Ω—é—î–º–æ –¥–∞—Ç–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–¥.–º–º
        const rowDate = dateCell ? dateCell.textContent.trim() : '';
        const jsDate = new Date(dateVal);
        const formatted = jsDate.toLocaleDateString('uk-UA', {day:'2-digit', month:'2-digit'});
        if (rowDate !== formatted) show = false;
      }
      if (statusVal) {
        if (row.getAttribute('data-status') !== statusVal) show = false;
      }
      row.style.display = show ? '' : 'none';
    });
  }

  if (filterStatus) filterStatus.addEventListener('change', filterTable);
  if (filterDate) filterDate.addEventListener('change', filterTable);
  if (resetBtn) {
    resetBtn.addEventListener('click', function() {
      if (filterDate) filterDate.value = '';
      if (filterStatus) filterStatus.value = '';
      filterTable();
    });
  }
  if (applyBtn) applyBtn.addEventListener('click', filterTable);
  
  // --- –õ–æ–≥—ñ–∫–∞ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ç–∏–∂–Ω—è ---
  const currentWeekBtn = document.getElementById('current-week-btn');
  const nextWeekBtn = document.getElementById('next-week-btn');
  
  function getFinancialWeekDates(offset = 0) {
    const today = new Date();
    const currentDay = today.getDay(); // 0 = –ù–µ–¥—ñ–ª—è, 5 = –ü'—è—Ç–Ω–∏—Ü—è, 6 = –°—É–±–æ—Ç–∞
    
    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞–π–±–ª–∏–∂—á—É –ø'—è—Ç–Ω–∏—Ü—é (5)
    let daysToFriday = 5 - currentDay;
    if (daysToFriday <= 0) daysToFriday += 7;
    
    // –ü–æ—á–∞—Ç–æ–∫ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ç–∏–∂–Ω—è (–ø'—è—Ç–Ω–∏—Ü—è)
    const friday = new Date(today);
    friday.setDate(today.getDate() + daysToFriday + (offset * 7));
    
    // –ö—ñ–Ω–µ—Ü—å —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ç–∏–∂–Ω—è (–Ω–∞—Å—Ç—É–ø–Ω–∞ —Å—É–±–æ—Ç–∞)
    const nextSaturday = new Date(friday);
    nextSaturday.setDate(friday.getDate() + 8); // +8 –¥–Ω—ñ–≤ = –Ω–∞—Å—Ç—É–ø–Ω–∞ —Å—É–±–æ—Ç–∞
    
    return {
      start: friday.toISOString().split('T')[0],
      end: nextSaturday.toISOString().split('T')[0]
    };
  }
  
  if (currentWeekBtn) {
    currentWeekBtn.addEventListener('click', function() {
      // –û—á–∏—â–∞—î–º–æ —ñ–Ω—à—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
      if (filterDate) filterDate.value = '';
      if (filterStatus) filterStatus.value = '';
      
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ —Ñ—ñ–ª—å—Ç—Ä–æ–º –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ç–∏–∂–Ω—è
      const url = new URL(window.location);
      url.searchParams.set('financial_week', '0');
      url.searchParams.delete('date');
      url.searchParams.delete('status');
      window.location.href = url.toString();
    });
  }
  
  if (nextWeekBtn) {
    nextWeekBtn.addEventListener('click', function() {
      // –û—á–∏—â–∞—î–º–æ —ñ–Ω—à—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
      if (filterDate) filterDate.value = '';
      if (filterStatus) filterStatus.value = '';
      
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ —Ñ—ñ–ª—å—Ç—Ä–æ–º –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ç–∏–∂–Ω—è
      const url = new URL(window.location);
      url.searchParams.set('financial_week', '1');
      url.searchParams.delete('date');
      url.searchParams.delete('status');
      window.location.href = url.toString();
    });
  }
  
  // –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
  const resetAllBtn = document.getElementById('reset-all-btn');
  if (resetAllBtn) {
    resetAllBtn.addEventListener('click', function() {
      const url = new URL(window.location);
      url.search = '';
      window.location.href = url.toString();
    });
  }

  // --- –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –∑–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É ---
  let currentDeliveryId = null;
  const assignModalElement = document.getElementById('assignCourierModal');
  const confirmModalElement = document.getElementById('confirmStatusModal');
  const assignModal = assignModalElement ? new bootstrap.Modal(assignModalElement) : null;
  const confirmModal = confirmModalElement ? new bootstrap.Modal(confirmModalElement) : null;

  document.querySelectorAll('.delivery-status').forEach(span => {
    span.addEventListener('click', function() {
      const status = this.dataset.status;
      currentDeliveryId = this.dataset.id;
      if (status === '–û—á—ñ–∫—É—î' && assignModal) {
        const courierSelect = document.getElementById('courierSelect');
        const assignError = document.getElementById('assign-error');
        if (courierSelect) courierSelect.value = '';
        if (assignError) assignError.classList.add('d-none');
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∞–¥—Ä–µ—Å—É –¥–ª—è —Ü—ñ—î—ó –¥–æ—Å—Ç–∞–≤–∫–∏
        const row = span.closest('tr');
        const city = row.querySelector('td:nth-child(2)').textContent.trim();
        const address = row.querySelector('td:nth-child(3)').textContent.trim();
        const date = row.querySelector('td:nth-child(9)').textContent.trim();
        const selectedAddresses = document.getElementById('selected-addresses');
        if (selectedAddresses) {
          selectedAddresses.innerHTML = `<b>–í–∏ –ø—Ä–∏–∑–Ω–∞—á–∞—î—Ç–µ –∫—É—Ä º—î—Ä–∞ –Ω–∞ –∞–¥—Ä–µ—Å—É:</b><ul><li>${city}, ${address} ‚Äî ${date}</li></ul>`;
        }
        assignModal.show();
      } else if (status === '–†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ' && confirmModal) {
        confirmModal.show();
      }
    });
  });

  // –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫—É—Ä'—î—Ä–∞ (submit)
  const assignCourierForm = document.getElementById('assignCourierForm');
  if (assignCourierForm) {
    assignCourierForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const courierId = document.getElementById('courierSelect') ? document.getElementById('courierSelect').value : '';
      const errorDiv = document.getElementById('assign-error');
      if (errorDiv) errorDiv.classList.add('d-none');
      if (!courierId) {
        if (errorDiv) {
          errorDiv.textContent = '–û–±–µ—Ä—ñ—Ç—å –∫—É—Ä º—î—Ä–∞!';
          errorDiv.classList.remove('d-none');
        }
        return;
      }
      fetch(`/deliveries/assign-courier`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({delivery_ids: [currentDeliveryId], courier_id: courierId})
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          if (errorDiv) {
            errorDiv.textContent = data.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ!';
            errorDiv.classList.remove('d-none');
          }
        }
      });
    });
  }

  // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è "–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ?"
  const confirmDeliveredBtn = document.getElementById('confirmDeliveredBtn');
  if (confirmDeliveredBtn) {
    confirmDeliveredBtn.onclick = function() {
      fetch(`/deliveries/${currentDeliveryId}/status`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'})
      }).then(r => r.json()).then(data => {
        if (data.success) {
          location.reload();
        }
      });
    }
  }

  // --- –õ–æ–≥—ñ–∫–∞ –¥–ª—è –∞–¥—Ä–µ—Å–∏ (–ø–æ–ø–∞–ø) ---
  const addressModalElement = document.getElementById('addressModal');
  const addressModal = addressModalElement ? new bootstrap.Modal(addressModalElement) : null;
  document.querySelectorAll('.address-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const city = this.dataset.city || '';
      const street = this.dataset.street || '';
      const building = this.dataset.building || '';
      const entrance = this.dataset.entrance || '';
      let html = `<b>–ú—ñ—Å—Ç–æ:</b> ${city}<br><b>–í—É–ª–∏—Ü—è:</b> ${street}<br><b>–ë—É–¥–∏–Ω–æ–∫:</b> ${building}`;
      if (entrance) html += `<br><b>–ü—ñ–¥'—ó–∑–¥:</b> ${entrance}`;
      const addressModalBody = document.getElementById('addressModalBody');
      if (addressModalBody) {
        addressModalBody.innerHTML = html;
      }
      if (addressModal) {
        addressModal.show();
      }
    });
  });

  // --- –õ–æ–≥—ñ–∫–∞ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏ (double click –ø–æ —Ä—è–¥–∫—É) ---
  const editModalElement = document.getElementById('editDeliveryModal');
  const editModal = editModalElement ? new bootstrap.Modal(editModalElement) : null;
  let currentId = null;
  
  if (!editModal) {
    console.error('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
  }
  
  document.querySelectorAll('tbody tr').forEach(row => {
    row.addEventListener('dblclick', function() {
      console.log('–î–∞–±–ª –∫–ª—ñ–∫ —Å–ø—Ä–∞—Ü—é–≤–∞–≤');
      const id = this.children[0].innerText;
      console.log('ID –¥–æ—Å—Ç–∞–≤–∫–∏:', id);
      currentId = id;
      
      fetch(`/deliveries/${id}`)
        .then(r => {
          console.log('Fetch response status:', r.status);
          if (!r.ok) {
            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–∫–∏');
          }
          return r.json();
        })
        .then(data => {
          console.log('–û—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ:', data);
          document.getElementById('editDeliveryId').value = data.id;
          document.getElementById('editCity').value = data.city || '';
          document.getElementById('editStreet').value = data.street || '';
          document.getElementById('editBuildingNumber').value = data.building_number || '';
          document.getElementById('editPhone').value = data.phone || '';
          document.getElementById('editTimeFrom').value = data.time_from || '';
          document.getElementById('editTimeTo').value = data.time_to || '';
          document.getElementById('editDeliveryDate').value = data.delivery_date || '';
          document.getElementById('editComment').value = data.comment || '';
          console.log('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è');
          if (editModal) {
            editModal.show();
          } else {
            console.error('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
            alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞');
          }
        })
        .catch(error => {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–∫–∏');
        });
    });
  });
  
  // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏
  const saveDeliveryBtn = document.getElementById('saveDeliveryBtn');
  if (saveDeliveryBtn) {
    saveDeliveryBtn.addEventListener('click', function() {
      if (!currentId) {
        alert('–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è');
        return;
      }
      
      const payload = {
        street: document.getElementById('editStreet').value,
        building_number: document.getElementById('editBuildingNumber').value,
        phone: document.getElementById('editPhone').value,
        time_from: document.getElementById('editTimeFrom').value,
        time_to: document.getElementById('editTimeTo').value,
        delivery_date: document.getElementById('editDeliveryDate').value,
        comment: document.getElementById('editComment').value
      };
      
      fetch(`/deliveries/${currentId}/edit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r => {
        if (!r.ok) {
          throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
        }
        return r.json();
      })
      .then(data => {
        if (data.success) {
          editModal.hide();
          location.reload();
        } else {
          alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
        }
      })
      .catch(error => {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏');
      });
    });
  } else {
    console.error('–ö–Ω–æ–ø–∫–∞ saveDeliveryBtn –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
  }
  
  // --- –õ–æ–≥—ñ–∫–∞ –¥–ª—è –∑–º—ñ–Ω–∏ –¥–∞—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ ---
  const changeDateModalElement = document.getElementById('changeDeliveryDateModal');
  const changeDateModal = changeDateModalElement ? new bootstrap.Modal(changeDateModalElement) : null;
  let currentDeliveryIdForDateChange = null;
  let changedDeliveries = new Set(); // –î–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–µ–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫
  
  // –ü–æ–¥–≤—ñ–π–Ω–∏–π –∫–ª—ñ–∫ –ø–æ –¥–∞—Ç—ñ –¥–æ—Å—Ç–∞–≤–∫–∏
  document.querySelectorAll('.delivery-date-cell').forEach(cell => {
    cell.addEventListener('dblclick', function(event) {
      event.stopPropagation(); // –ù–µ –¥–∞—î–º–æ –ø–æ–¥—ñ—ó –ø—ñ–¥–Ω—è—Ç–∏—Å—å –¥–æ tr
      const deliveryId = this.dataset.deliveryId;
      currentDeliveryIdForDateChange = deliveryId;
      
      // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏
      fetch(`/deliveries/${deliveryId}`)
        .then(r => r.json())
        .then(data => {
          // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞
          document.getElementById('client-info').textContent = data.client_instagram || '–ù–µ–≤—ñ–¥–æ–º–æ';
          document.getElementById('phone-info').textContent = data.phone || '–ù–µ–≤—ñ–¥–æ–º–æ';
          
          // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É
          document.getElementById('newDeliveryDate').value = data.delivery_date;
          
          // –û—Ç—Ä–∏–º—É—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ü—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
          return fetch(`/deliveries/${deliveryId}/future-deliveries`);
        })
        .then(r => r.json())
        .then(futureDeliveries => {
          const futureList = document.getElementById('future-deliveries-list');
          if (futureDeliveries.length === 0) {
            futureList.innerHTML = '<p class="text-muted">–ù–µ–º–∞—î –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫</p>';
          } else {
            let html = '<div class="row">';
            futureDeliveries.forEach(delivery => {
              const isChanged = changedDeliveries.has(delivery.id);
              html += `
                <div class="col-md-6 mb-2">
                  <div class="card ${isChanged ? 'border-warning' : 'border-light'}">
                    <div class="card-body p-2">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <small class="text-muted">ID: ${delivery.id}</small><br>
                          <strong>${delivery.delivery_date}</strong>
                        </div>
                        <div>
                          <input type="date" class="form-control form-control-sm future-date-input" 
                                 data-delivery-id="${delivery.id}" 
                                 value="${delivery.delivery_date}"
                                 style="width: 140px;">
                          ${isChanged ? '<span class="badge bg-warning text-dark ms-1">–ó–º—ñ–Ω–µ–Ω–æ</span>' : ''}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            });
            html += '</div>';
            futureList.innerHTML = html;
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∑–º—ñ–Ω–∏ –¥–∞—Ç –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–æ–∫
            document.querySelectorAll('.future-date-input').forEach(input => {
              input.addEventListener('change', function() {
                const deliveryId = this.dataset.deliveryId;
                changedDeliveries.add(deliveryId);
                this.closest('.card').classList.remove('border-light');
                this.closest('.card').classList.add('border-warning');
                
                // –î–æ–¥–∞—î–º–æ –±–µ–π–¥–∂ "–ó–º—ñ–Ω–µ–Ω–æ"
                const cardBody = this.closest('.card-body');
                const existingBadge = cardBody.querySelector('.badge');
                if (!existingBadge) {
                  const badge = document.createElement('span');
                  badge.className = 'badge bg-warning text-dark ms-1';
                  badge.textContent = '–ó–º—ñ–Ω–µ–Ω–æ';
                  this.parentNode.appendChild(badge);
                }
              });
            });
          }
          
          if (changeDateModal) {
            changeDateModal.show();
          }
        })
        .catch(error => {
          console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:', error);
          alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–æ—Å—Ç–∞–≤–∫–∏');
        });
    });
  });
  
  // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–µ–Ω–∏—Ö –¥–∞—Ç
  const saveDeliveryDateBtn = document.getElementById('saveDeliveryDateBtn');
  if (saveDeliveryDateBtn) {
    saveDeliveryDateBtn.addEventListener('click', function() {
      if (!currentDeliveryIdForDateChange) {
        alert('–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –¥–æ—Å—Ç–∞–≤–∫—É –¥–ª—è –∑–º—ñ–Ω–∏');
        return;
      }
      
      const newDate = document.getElementById('newDeliveryDate').value;
      if (!newDate) {
        alert('–í–∏–±–µ—Ä—ñ—Ç—å –Ω–æ–≤—É –¥–∞—Ç—É –¥–æ—Å—Ç–∞–≤–∫–∏');
        return;
      }
      
      // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –∑–º—ñ–Ω–µ–Ω—ñ –¥–∞—Ç–∏
      const changedDates = {};
      changedDates[currentDeliveryIdForDateChange] = newDate;
      
      document.querySelectorAll('.future-date-input').forEach(input => {
        const deliveryId = input.dataset.deliveryId;
        const dateValue = input.value;
        if (dateValue && dateValue !== input.defaultValue) {
          changedDates[deliveryId] = dateValue;
        }
      });
      
      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–º—ñ–Ω–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      fetch(`/deliveries/${currentDeliveryIdForDateChange}/change-dates`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({changed_dates: changedDates})
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          changeDateModal.hide();
          location.reload();
        } else {
          const errorDiv = document.getElementById('date-change-error');
          errorDiv.textContent = data.error || '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞—Ç';
          errorDiv.classList.remove('d-none');
        }
      })
      .catch(error => {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞—Ç –¥–æ—Å—Ç–∞–≤–∫–∏');
      });
    });
  }
});
</script>
{% endblock %} 