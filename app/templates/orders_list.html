{% extends 'layout.html' %}
{% block content %}
<h2 class="mb-4">Список замовлень</h2>
<div class="mb-2"><strong>Всього замовлень: {{ orders_count }}</strong></div>
<div class="mb-3">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">Додати замовлення</button>
</div>
<form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-md-4">
        <input type="text" class="form-control" name="phone" placeholder="Пошук за номером телефону..." value="{{ request.args.get('phone', '') }}">
    </div>
    <div class="col-md-4">
        <input type="text" class="form-control" name="instagram" placeholder="Пошук за Instagram..." value="{{ request.args.get('instagram', '') }}">
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-outline-primary w-100">Застосувати</button>
    </div>
</form>
<table class="table table-bordered table-hover align-middle" id="orders-table">
    <thead>
        <tr>
            <th>Клієнт</th>
            <th>Отримувач</th>
            <th>Телефон отримувача</th>
            <th>Місто</th>
            <th>Адреса</th>
            <th>Тип доставки</th>
            <th>Розмір</th>
            <th>Дата першої доставки</th>
            <th>День</th>
            <th>Час</th>
            <th>Для кого</th>
            <th>Коментар</th>
        </tr>
    </thead>
    <tbody>
    {% for order in orders_on_page %}
        <tr data-order-id="{{ order.id }}">
            <td>{{ order.client.instagram or '' }}</td>
            <td>{{ order.recipient_name or '' }}</td>
            <td>{{ order.recipient_phone or '' }}</td>
            <td>{{ order.city or '' }}</td>
            <td>
                {% if order.is_pickup %}
                    <span class="badge bg-warning">Самовивіз</span>
                {% else %}
                    {{ order.street or '' }}
                    {% if order.building_number %}, {{ order.building_number }}{% endif %}
                    {% if order.floor %}, {{ order.floor }}{% endif %}
                    {% if order.entrance %}, {{ order.entrance }}{% endif %}
                {% endif %}
            </td>
            <td>{{ order.delivery_type or '' }}</td>
            <td>
                {{ order.size or '' }}
                {% if order.size == 'Custom' and order.custom_amount %}
                    ({{ order.custom_amount }} грн)
                {% endif %}
            </td>
            <td>{{ order.first_delivery_date.strftime('%d.%m.%Y') if order.first_delivery_date else '' }}</td>
            <td>{{ order.delivery_day or '' }}</td>
            <td>
                {% if order.time_from and order.time_to %}
                    {{ order.time_from }} - {{ order.time_to }}
                {% elif order.time_from %}
                    {{ order.time_from }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td>{{ order.for_whom or '' }}</td>
            <td>
                {% if order.comment %}
                    <span class="text-muted" title="{{ order.comment }}">{{ order.comment[:30] }}{% if order.comment|length > 30 %}...{% endif %}</span>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
<div class="d-flex justify-content-center align-items-center gap-2">
    <form method="get" style="display:inline;">
        {% for key, value in request.args.items() %}
            {% if key != 'page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button class="btn btn-secondary" name="page" value="{{ prev_page }}" {% if page == 1 %}disabled{% endif %}>Назад</button>
    </form>
    <span class="mx-2">{{ page }}</span>
    <form method="get" style="display:inline;">
        {% for key, value in request.args.items() %}
            {% if key != 'page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button class="btn btn-secondary" name="page" value="{{ next_page }}" {% if not has_next %}disabled{% endif %}>Вперед</button>
    </form>
</div>

<!-- Модалка створення замовлення -->
<div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form id="addOrderForm">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="addOrderModalLabel">Створення замовлення</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body bg-white">
          <div class="container-fluid">
            <div class="row g-3">
              <!-- Клієнт -->
              <div class="col-md-6">
                <label class="form-label">Клієнт <span class="text-danger">*</span></label>
                <div class="position-relative">
                  <input type="text" class="form-control" id="client-search" name="client_instagram" 
                         placeholder="Введіть Instagram клієнта..." required autocomplete="off">
                  <div class="list-group position-absolute w-100 d-none" id="client-results" 
                       style="z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                </div>
              </div>
              <!-- Отримувач -->
              <div class="col-md-6">
                <label class="form-label">Ім'я отримувача <span class="text-danger">*</span></label>
                <input type="text" name="recipient_name" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Номер телефону отримувача <span class="text-danger">*</span></label>
                <input type="text" name="recipient_phone" class="form-control" required 
                       placeholder="+380" pattern="\+380[0-9]{9}" maxlength="13">
              </div>
              <div class="col-md-6">
                <label class="form-label">Instagram/Telegram отримувача</label>
                <input type="text" name="recipient_social" class="form-control" placeholder="Необов'язково">
              </div>
              <!-- Адреса -->
              <div class="col-md-6">
                <label class="form-label">Місто <span class="text-danger">*</span></label>
                <select name="city" class="form-select" required>
                  <option value="Київ" selected>Київ</option>
                  <option value="Бровари">Бровари</option>
                  <option value="Вишгород">Вишгород</option>
                  <option value="Ірпінь">Ірпінь</option>
                </select>
              </div>
              <div class="col-md-6">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="is-pickup" name="is_pickup">
                  <label class="form-check-label" for="is-pickup">
                    Самовивіз
                  </label>
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label">Адреса <span class="text-danger">*</span></label>
                <input type="text" name="street" id="address-input" class="form-control" required>
              </div>
              <!-- Тип доставки -->
              <div class="col-md-6">
                <label class="form-label">Тип доставки <span class="text-danger">*</span></label>
                <select name="delivery_type" class="form-select" required>
                  <option value="">Оберіть тип</option>
                  <option value="Weekly">Weekly</option>
                  <option value="Monthly">Monthly</option>
                  <option value="Bi-weekly">Bi-weekly</option>
                  <option value="One-time">One-time</option>
                </select>
              </div>
              <!-- Розмір -->
              <div class="col-md-6">
                <label class="form-label">Розмір <span class="text-danger">*</span></label>
                <select name="size" id="size-select" class="form-select" required>
                  <option value="">Оберіть розмір</option>
                  <option value="M">M</option>
                  <option value="L">L</option>
                  <option value="XL">XL</option>
                  <option value="XXL">XXL</option>
                  <option value="Custom">Власний</option>
                </select>
              </div>
              <div class="col-md-6" id="custom-amount-div" style="display: none;">
                <label class="form-label">Сума <span class="text-danger">*</span></label>
                <input type="number" name="custom_amount" class="form-control" min="0" placeholder="Введіть суму">
              </div>
              <!-- Дата та день -->
              <div class="col-md-6">
                <label class="form-label">Дата першої доставки <span class="text-danger">*</span></label>
                <input type="date" name="first_delivery_date" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">День <span class="text-danger">*</span></label>
                <select name="delivery_day" class="form-select" required>
                  <option value="">Оберіть день</option>
                  <option value="ПН">ПН</option>
                  <option value="ВТ">ВТ</option>
                  <option value="СР">СР</option>
                  <option value="ЧТ">ЧТ</option>
                  <option value="ПТ">ПТ</option>
                  <option value="СБ">СБ</option>
                  <option value="НД">НД</option>
                </select>
              </div>
              <!-- Час -->
              <div class="col-md-3">
                <label class="form-label">Час з</label>
                <input type="time" name="time_from" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">Час до</label>
                <input type="time" name="time_to" class="form-control">
              </div>
              <!-- Для кого -->
              <div class="col-md-6">
                <label class="form-label">Для кого <span class="text-danger">*</span></label>
                <select name="for_whom" class="form-select" required>
                  <option value="">Оберіть варіант</option>
                  <option value="дівчина собі">дівчина собі</option>
                  <option value="дівчина іншій дівчині">дівчина іншій дівчині</option>
                  <option value="хлопець дівчині">хлопець дівчині</option>
                  <option value="хлопець собі">хлопець собі</option>
                  <option value="корпоративна підписка">корпоративна підписка</option>
                  <option value="весільна підписка">весільна підписка</option>
                  <option value="хлопець хлопцю">хлопець хлопцю</option>
                </select>
              </div>
              <!-- Коментар та побажання -->
              <div class="col-md-6">
                <label class="form-label">Коментар</label>
                <textarea name="comment" class="form-control" rows="3" placeholder="Додаткові коментарі..."></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Побажання</label>
                <textarea name="preferences" class="form-control" rows="3" placeholder="Особливі побажання..."></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
          <button type="submit" class="btn btn-primary" id="order-submit-btn">Створити замовлення</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- МОДАЛКА СТВОРЕННЯ ЗАМОВЛЕННЯ ---
    const clientSearch = document.getElementById('client-search');
    const clientResults = document.getElementById('client-results');
    const isPickupCheckbox = document.getElementById('is-pickup');
    const addressInput = document.getElementById('address-input');
    const sizeSelect = document.getElementById('size-select');
    const customAmountDiv = document.getElementById('custom-amount-div');
    const customAmountInput = document.querySelector('#addOrderForm input[name="custom_amount"]');
    const addOrderForm = document.getElementById('addOrderForm');
    const recipientPhoneInput = addOrderForm.querySelector('input[name="recipient_phone"]');
    
    if (recipientPhoneInput) {
        recipientPhoneInput.setAttribute('maxlength', '13');
    }

    // Автопошук клієнтів
    if (clientSearch) {
        clientSearch.addEventListener('input', async function() {
            const query = this.value.trim();
            if (query.length < 2) {
                clientResults.classList.add('d-none');
                return;
            }
            try {
                const response = await fetch(`/clients/search?q=${encodeURIComponent(query)}`);
                const clients = await response.json();
                if (clients.length > 0) {
                    clientResults.innerHTML = clients.map(client => 
                        `<button type="button" class="list-group-item list-group-item-action">${client.instagram}</button>`
                    ).join('');
                    clientResults.classList.remove('d-none');
                    clientResults.querySelectorAll('button').forEach(btn => {
                        btn.addEventListener('click', function() {
                            clientSearch.value = this.textContent;
                            clientResults.classList.add('d-none');
                        });
                    });
                } else {
                    clientResults.classList.add('d-none');
                }
            } catch (error) {
                console.error('Помилка пошуку клієнтів:', error);
            }
        });
        clientSearch.addEventListener('blur', function() {
            setTimeout(() => clientResults.classList.add('d-none'), 200);
        });
    }

    // Самовивіз - деактивація адреси і required
    if (isPickupCheckbox) {
        isPickupCheckbox.addEventListener('change', function() {
            if (this.checked) {
                addressInput.value = '';
                addressInput.disabled = true;
                addressInput.removeAttribute('required');
            } else {
                addressInput.disabled = false;
                addressInput.setAttribute('required', 'required');
            }
        });
    }

    // Власний розмір - показ поля суми
    if (sizeSelect) {
        sizeSelect.addEventListener('change', function() {
            if (this.value === 'Custom') {
                customAmountDiv.style.display = 'block';
                customAmountInput.required = true;
            } else {
                customAmountDiv.style.display = 'none';
                customAmountInput.required = false;
                customAmountInput.value = '';
            }
        });
    }

    // Маска для номера телефону отримувача (тільки + і цифри, не більше 13)
    if (recipientPhoneInput) {
        recipientPhoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d+]/g, '');
            if (!value.startsWith('+')) value = '+' + value.replace(/^\+/, '');
            value = value.slice(0, 13);
            e.target.value = value;
        });
        recipientPhoneInput.addEventListener('focus', function(e) {
            if (e.target.value === '') {
                e.target.value = '+38';
            }
        });
    }

    // Валідація та AJAX submit
    if (addOrderForm) {
        addOrderForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            // Валідація телефону
            const phoneValue = recipientPhoneInput.value;
            const phonePattern = /^\+380[0-9]{9}$/;
            if (!phonePattern.test(phoneValue) || phoneValue.length !== 13) {
                showOrderError('Телефон має бути у форматі +380XXXXXXXXX (13 символів)');
                return;
            }
            if (!isPickupCheckbox.checked && !addressInput.value.trim()) {
                showOrderError('Вкажіть адресу або оберіть "Самовивіз"');
                return;
            }
            if (sizeSelect.value === 'Custom' && (!customAmountInput.value || customAmountInput.value <= 0)) {
                showOrderError('Для власного розміру потрібно вказати суму більше 0');
                return;
            }
            
            // AJAX submit
            const formData = new FormData(addOrderForm);
            const orderId = addOrderForm.getAttribute('data-edit-id');
            let url = '/orders/new';
            if (orderId) {
                url = `/orders/${orderId}/edit`;
            }
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'X-Requested-With': 'XMLHttpRequest'},
                    body: formData
                });
                if (response.ok) {
                    // Успіх: закриваємо модалку, оновлюємо сторінку
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addOrderModal'));
                    if (modal) modal.hide();
                    location.reload();
                } else {
                    const data = await response.json();
                    showOrderError(data.error || 'Помилка збереження замовлення!');
                }
            } catch (error) {
                showOrderError('Помилка зʼєднання з сервером!');
            }
        });
    }

    // Вивід помилок у модалці
    function showOrderError(msg) {
        let msgDiv = document.getElementById('add-order-error');
        if (!msgDiv) {
            msgDiv = document.createElement('div');
            msgDiv.id = 'add-order-error';
            msgDiv.className = 'alert alert-danger';
            addOrderForm.querySelector('.modal-body').prepend(msgDiv);
        }
        msgDiv.textContent = msg;
        msgDiv.classList.remove('d-none');
    }

    // При відкритті модалки для створення замовлення
    const addOrderBtn = document.querySelector('[data-bs-target="#addOrderModal"]');
    if (addOrderBtn) {
        addOrderBtn.addEventListener('click', function() {
            const form = document.getElementById('addOrderForm');
            if (form) {
                form.reset();
                form.removeAttribute('data-edit-id');
                const submitBtn = document.getElementById('order-submit-btn');
                if (submitBtn) {
                    submitBtn.textContent = 'Створити замовлення';
                }
                // Скидаємо всі custom поля, required, disabled тощо
                const streetInput = form.querySelector('[name="street"]');
                if (streetInput) {
                    streetInput.disabled = false;
                    streetInput.setAttribute('required', 'required');
                }
                if (customAmountDiv) {
                    customAmountDiv.style.display = 'none';
                }
                if (customAmountInput) {
                    customAmountInput.required = false;
                }
            }
        });
    }

    // --- РЕДАГУВАННЯ ЗАМОВЛЕНЬ ЧЕРЕЗ ПОДВІЙНИЙ КЛІК ---
    document.querySelectorAll('#orders-table tbody tr').forEach(row => {
        row.addEventListener('dblclick', async function() {
            const orderId = this.getAttribute('data-order-id');
            try {
                const response = await fetch(`/orders/${orderId}/edit`);
                const orderData = await response.json();
                
                // Заповнюємо форму даними замовлення
                addOrderForm.setAttribute('data-edit-id', orderId);
                addOrderForm.querySelector('[name="client_instagram"]').value = orderData.client_instagram;
                addOrderForm.querySelector('[name="recipient_name"]').value = orderData.recipient_name;
                addOrderForm.querySelector('[name="recipient_phone"]').value = orderData.recipient_phone;
                addOrderForm.querySelector('[name="recipient_social"]').value = orderData.recipient_social || '';
                addOrderForm.querySelector('[name="city"]').value = orderData.city;
                addOrderForm.querySelector('[name="street"]').value = orderData.street;
                addOrderForm.querySelector('[name="delivery_type"]').value = orderData.delivery_type;
                addOrderForm.querySelector('[name="size"]').value = orderData.size;
                addOrderForm.querySelector('[name="custom_amount"]').value = orderData.custom_amount || '';
                addOrderForm.querySelector('[name="first_delivery_date"]').value = orderData.first_delivery_date;
                addOrderForm.querySelector('[name="delivery_day"]').value = orderData.delivery_day;
                addOrderForm.querySelector('[name="time_from"]').value = orderData.time_from || '';
                addOrderForm.querySelector('[name="time_to"]').value = orderData.time_to || '';
                addOrderForm.querySelector('[name="for_whom"]').value = orderData.for_whom;
                addOrderForm.querySelector('[name="comment"]').value = orderData.comment || '';
                addOrderForm.querySelector('[name="preferences"]').value = orderData.preferences || '';
                
                // Самовивіз
                const isPickup = orderData.is_pickup;
                addOrderForm.querySelector('[name="is_pickup"]').checked = isPickup;
                const addressInput = addOrderForm.querySelector('[name="street"]');
                if (isPickup) {
                    addressInput.value = '';
                    addressInput.disabled = true;
                    addressInput.removeAttribute('required');
                } else {
                    addressInput.disabled = false;
                    addressInput.setAttribute('required', 'required');
                }
                
                // Власний розмір
                const sizeSelect = addOrderForm.querySelector('[name="size"]');
                const customAmountDiv = document.getElementById('custom-amount-div');
                const customAmountInput = addOrderForm.querySelector('[name="custom_amount"]');
                if (orderData.size === 'Custom') {
                    customAmountDiv.style.display = 'block';
                    customAmountInput.required = true;
                } else {
                    customAmountDiv.style.display = 'none';
                    customAmountInput.required = false;
                    customAmountInput.value = '';
                }
                
                // Відкриваємо модалку
                const modal = new bootstrap.Modal(document.getElementById('addOrderModal'));
                modal.show();
                document.getElementById('order-submit-btn').textContent = 'Зберегти зміни';
            } catch (error) {
                alert('Помилка завантаження даних замовлення');
            }
        });
    });
});
</script>
{% endblock %} 