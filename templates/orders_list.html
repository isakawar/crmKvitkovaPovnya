{% extends 'layout.html' %}
{% block content %}
<h2 class="mb-4">Список замовлень</h2>
<div class="mb-3">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">Додати замовлення</button>
</div>
<form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-md-3">
        <input type="text" class="form-control" name="phone" placeholder="Пошук за номером телефону..." value="{{ request.args.get('phone', '') }}">
    </div>
    <div class="col-md-3">
        <input type="text" class="form-control" name="instagram" placeholder="Пошук за Instagram..." value="{{ request.args.get('instagram', '') }}">
    </div>
    <div class="col-md-3">
        <select class="form-select" name="city">
            <option value="">Всі міста</option>
            {% for city in cities %}
                <option value="{{ city }}" {% if request.args.get('city') == city %}selected{% endif %}>{{ city }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-outline-primary w-100">Застосувати</button>
    </div>
</form>
<table class="table table-bordered table-hover align-middle" id="orders-table">
    <thead>
        <tr>
            <th>Instagram</th>
            <th>Місто</th>
            <th>Вулиця</th>
            <th>Номер будинку</th>
            <th>КВ/поверх</th>
            <th>Під'їзд</th>
            <th>Телефон</th>
            <th>Тип</th>
            <th>Розмір</th>
            <th>Коментар</th>
            <th>Часове вікно</th>
        </tr>
    </thead>
    <tbody>
    {% for order in orders_on_page %}
        <tr data-order-id="{{ order.id }}">
            <td>{{ order.client.instagram }}</td>
            <td>{{ order.client.city }}</td>
            <td>{{ order.street }}</td>
            <td>{{ order.building_number }}</td>
            <td>{{ order.floor }}</td>
            <td>{{ order.entrance }}</td>
            <td>{{ order.client.phone }}</td>
            <td>{{ order.type }}</td>
            <td>{{ order.size }}</td>
            <td>{{ order.comment }}</td>
            <td>{{ order.time_window }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
<div class="d-flex justify-content-center align-items-center gap-2">
    <form method="get" style="display:inline;">
        {% for key, value in request.args.items() %}
            {% if key != 'page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button class="btn btn-secondary" name="page" value="{{ prev_page }}" {% if page == 1 %}disabled{% endif %}>Назад</button>
    </form>
    <span class="mx-2">{{ page }}</span>
    <form method="get" style="display:inline;">
        {% for key, value in request.args.items() %}
            {% if key != 'page' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button class="btn btn-secondary" name="page" value="{{ next_page }}" {% if not has_next %}disabled{% endif %}>Вперед</button>
    </form>
</div>

<!-- Modal -->
<div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="/orders/new" id="addOrderForm">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="addOrderModalLabel">Додати замовлення</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body bg-white">
          <div class="container-fluid">
            <div class="row g-3">
              <div class="col-md-4 position-relative" style="z-index:1055;">
                <label class="form-label">Клієнт (номер телефону)</label>
                <input type="text" class="form-control" id="order-client-phone" name="phone" placeholder="Введіть номер телефону..." autocomplete="off" required>
                <div class="list-group d-none" id="client-phone-list" style="position:absolute; top:100%; left:0; right:0; max-height:220px; overflow-y:auto; box-shadow:0 4px 16px rgba(0,0,0,0.10); z-index:1060;"></div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Отримувач (телефон)</label>
                <input type="text" name="recipient_phone" class="form-control" placeholder="Введіть номер телефону отримувача" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Місто</label>
                <select name="city" class="form-select" required>
                  <option value="Київ" selected>Київ</option>
                  <option value="Бровари">Бровари</option>
                  <option value="Вишгород">Вишгород</option>
                  <option value="Ірпінь">Ірпінь</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Вулиця</label>
                <input type="text" name="street" class="form-control" required>
              </div>
              <div class="col-md-2">
                <label class="form-label">Номер будинку</label>
                <input type="text" name="building_number" class="form-control">
              </div>
              <div class="col-md-2">
                <label class="form-label">Кв/підʼїзд</label>
                <input type="text" name="entrance" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Тип доставки</label>
                <select name="type" class="form-select" id="order-delivery-type" required>
                  <option value="">Оберіть тип</option>
                  <option value="Доставка - підписка">Доставка - підписка</option>
                  <option value="Самовивіз - підписка">Самовивіз - підписка</option>
                  <option value="Доставка">Доставка</option>
                  <option value="Самовивіз">Самовивіз</option>
                </select>
              </div>
              <div class="col-md-4" id="bouquet-select-wrap">
                <label class="form-label">Букет</label>
                <select name="bouquet_id" class="form-select" id="order-bouquet-select" disabled>
                  <option value="">Оберіть букет</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Кількість доставок</label>
                <input type="number" name="delivery_count" class="form-control" min="1" value="1" required disabled id="delivery-count-input">
              </div>
              <div class="col-md-4">
                <label class="form-label">Бажані дні</label>
                <select name="preferred_days" class="form-select" multiple disabled id="preferred-days-select">
                  <option value="пн">Пн</option>
                  <option value="вт">Вт</option>
                  <option value="ср">Ср</option>
                  <option value="чт">Чт</option>
                  <option value="пт">Пт</option>
                  <option value="сб">Сб</option>
                  <option value="нд">Нд</option>
                </select>
              </div>
              <div class="col-md-4" id="periodicity-wrap">
                <label class="form-label">Періодичність</label>
                <select name="periodicity" class="form-select" disabled id="periodicity-select">
                  <option value="1/7">1/7</option>
                  <option value="1/14">1/14</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Час з</label>
                <input type="time" name="time_from" class="form-control" disabled id="time-from-input">
              </div>
              <div class="col-md-2">
                <label class="form-label">Час до</label>
                <input type="time" name="time_to" class="form-control" disabled id="time-to-input">
              </div>
              <div class="col-md-12">
                <label class="form-label">Коментар</label>
                <textarea name="comment" class="form-control"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
          <button type="submit" class="btn btn-primary">Додати</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal редагування -->
<div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editOrderForm">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="editOrderModalLabel">Редагувати замовлення</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body bg-white">
          <input type="hidden" name="order_id" id="edit-order-id">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Instagram</label>
              <input type="text" name="instagram" id="edit-instagram" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Місто</label>
              <input type="text" name="city" id="edit-city" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Вулиця</label>
              <input type="text" name="street" id="edit-street" class="form-control" required>
            </div>
            <div class="col-md-2">
              <label class="form-label">Номер будинку</label>
              <input type="text" name="building_number" id="edit-building_number" class="form-control">
            </div>
            <div class="col-md-2">
              <label class="form-label">КВ/поверх</label>
              <input type="text" name="floor" id="edit-floor" class="form-control">
            </div>
            <div class="col-md-2">
              <label class="form-label">Під'їзд</label>
              <input type="text" name="entrance" id="edit-entrance" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Телефон</label>
              <input type="text" name="phone" id="edit-phone" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Тип доставки</label>
              <select name="type" id="edit-type" class="form-select">
                <option value="Разова">Разова</option>
                <option value="Постійна">Постійна</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Розмір</label>
              <input type="text" name="size" id="edit-size" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Часове вікно</label>
              <input type="text" name="time_window" id="edit-time_window" class="form-control">
            </div>
            <div class="col-md-12">
              <label class="form-label">Коментар</label>
              <textarea name="comment" id="edit-comment" class="form-control"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light d-flex justify-content-between">
          <div>
            <button type="button" class="btn btn-outline-danger" id="delete-order-btn">Видалити</button>
          </div>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
            <button type="submit" class="btn btn-primary">Зберегти</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal підтвердження видалення -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Підтвердження видалення</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Ви впевнені, що хочете видалити це замовлення?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ні</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-yes">Так</button>
      </div>
    </div>
  </div>
</div>

<script>
let allClients = [];
document.addEventListener('DOMContentLoaded', function() {
  // Завантажити всіх клієнтів для автокомпліта
  fetch('/clients/json').then(r => r.json()).then(data => { allClients = data; });
  const phoneInput = document.getElementById('order-client-phone');
  const listDiv = document.getElementById('client-phone-list');
  phoneInput.addEventListener('input', function() {
    const val = phoneInput.value.trim();
    if (!val) { listDiv.classList.add('d-none'); return; }
    const filtered = allClients.filter(c => c.phone.includes(val));
    if (filtered.length === 0) { listDiv.classList.add('d-none'); return; }
    listDiv.innerHTML = filtered.map(c => `<button type="button" class="list-group-item list-group-item-action">${c.phone}</button>`).join('');
    listDiv.classList.remove('d-none');
    // Клік по варіанту
    Array.from(listDiv.children).forEach(btn => {
      btn.onclick = () => {
        phoneInput.value = btn.textContent;
        listDiv.classList.add('d-none');
      };
    });
  });
  // При втраті фокусу ховаємо список через 200мс (щоб встиг клікнути)
  phoneInput.addEventListener('blur', function() { setTimeout(() => listDiv.classList.add('d-none'), 200); });

  // Double-click по рядку — відкриває модалку редагування
  const table = document.getElementById('orders-table');
  table.addEventListener('dblclick', async function(e) {
    let tr = e.target.closest('tr[data-order-id]');
    if (!tr) return;
    const orderId = tr.getAttribute('data-order-id');
    // Завантажуємо дані замовлення
    const resp = await fetch(`/orders/${orderId}/edit`);
    const data = await resp.json();
    document.getElementById('edit-order-id').value = data.id;
    document.getElementById('edit-instagram').value = data.instagram;
    document.getElementById('edit-phone').value = data.phone;
    document.getElementById('edit-city').value = data.city;
    document.getElementById('edit-street').value = data.street;
    document.getElementById('edit-building_number').value = data.building_number;
    document.getElementById('edit-floor').value = data.floor;
    document.getElementById('edit-entrance').value = data.entrance;
    document.getElementById('edit-size').value = data.size;
    document.getElementById('edit-type').value = data.type;
    document.getElementById('edit-comment').value = data.comment;
    document.getElementById('edit-time_window').value = data.time_window;
    let modal = new bootstrap.Modal(document.getElementById('editOrderModal'));
    modal.show();
  });

  // Відправка форми редагування через AJAX
  const editForm = document.getElementById('editOrderForm');
  editForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const orderId = document.getElementById('edit-order-id').value;
    const formData = new FormData(editForm);
    const resp = await fetch(`/orders/${orderId}/edit`, {
      method: 'POST',
      body: formData
    });
    if (resp.ok) {
      location.reload();
    }
  });

  // Видалення замовлення через окремий попап
  let orderIdToDelete = null;
  const deleteBtn = document.getElementById('delete-order-btn');
  const confirmDeleteModalEl = document.getElementById('confirmDeleteModal');
  const confirmDeleteModal = confirmDeleteModalEl ? new bootstrap.Modal(confirmDeleteModalEl) : null;
  const confirmDeleteYes = document.getElementById('confirm-delete-yes');
  if (deleteBtn && confirmDeleteModal && confirmDeleteYes) {
    deleteBtn.addEventListener('click', function() {
      orderIdToDelete = document.getElementById('edit-order-id').value;
      confirmDeleteModal.show();
    });
    confirmDeleteYes.addEventListener('click', async function() {
      if (!orderIdToDelete) return;
      const resp = await fetch(`/orders/${orderIdToDelete}/delete`, {method: 'POST'});
      if (resp.ok) {
        confirmDeleteModal.hide();
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editOrderModal'));
        if (editModal) editModal.hide();
        location.reload();
      }
    });
  } else {
    console.warn('Delete button/modal/yes not found');
  }

  // Динамічне оновлення букетів за типом доставки
  const deliveryType = document.getElementById('order-delivery-type');
  const bouquetWrap = document.getElementById('bouquet-select-wrap');
  const bouquetSelect = document.getElementById('order-bouquet-select');
  const periodicityWrap = document.getElementById('periodicity-wrap');
  const periodicitySelect = document.getElementById('periodicity-select');
  const deliveryCountInput = document.getElementById('delivery-count-input');
  const preferredDaysSelect = document.getElementById('preferred-days-select');
  const timeFromInput = document.getElementById('time-from-input');
  const timeToInput = document.getElementById('time-to-input');

  function setDependentFieldsEnabled(enabled, isSubscription) {
    bouquetSelect.disabled = !enabled;
    deliveryCountInput.disabled = !enabled;
    preferredDaysSelect.disabled = !enabled;
    timeFromInput.disabled = !enabled;
    timeToInput.disabled = !enabled;
    periodicitySelect.disabled = !(enabled && isSubscription);
  }

  setDependentFieldsEnabled(false, false);

  deliveryType.addEventListener('change', function() {
    const type = deliveryType.value;
    if (!type) {
      setDependentFieldsEnabled(false, false);
      return;
    }
    fetch(`/orders/bouquets?delivery_type=${encodeURIComponent(type.replace(' - підписка',''))}`)
      .then(r => r.json())
      .then(data => {
        bouquetSelect.innerHTML = '<option value="">Оберіть букет</option>' +
          data.map(b => `<option value="${b.id}">${b.bouquet_size} — ${b.price} грн</option>`).join('');
      });
    const isSubscription = type.includes('підписка');
    setDependentFieldsEnabled(true, isSubscription);
  });
});
</script>
{% endblock %} 